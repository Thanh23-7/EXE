<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông Tin Tài Khoản - Green Fresh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Các style giữ nguyên từ bản gốc */
        .bg-gradient-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-primary { 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
            color: #fff;
            box-shadow: 0 2px 8px rgba(16,185,129,0.15);
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(16,185,129,0.2);
        }
        /* FIX cho dropdown profile */
        .group:hover .group-hover\:opacity-100 {
            opacity: 1 !important;
            visibility: visible !important;
            transform: scale(1) !important;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between py-4">
                <a href="index.html" class="flex items-center space-x-2">
                    <div class="w-10 h-10 bg-gradient-green rounded-full flex items-center justify-center shadow-lg">
                        <i class="fas fa-leaf text-white text-xl"></i>
                    </div>
                    <span class="text-2xl font-extrabold text-green-600 tracking-wide">Green Fresh</span>
                </a>
                <nav class="hidden md:flex space-x-8">
                    <a href="index.html" class="text-gray-700 hover:text-green-600 font-semibold transition">Trang chủ</a>
                    <a href="product.html" class="text-gray-700 hover:text-green-600 font-semibold transition">Sản phẩm</a>
                    <a href="product-detail.html" class="text-gray-700 hover:text-green-600 font-semibold transition">Về chúng tôi</a>
                    <a href="forgotpassword.html" class="text-gray-700 hover:text-green-600 font-semibold transition">Liên hệ</a>
                </nav>
                <div class="flex items-center space-x-4">
                    <div class="relative hidden md:block">
                        <input type="text" placeholder="Tìm kiếm sản phẩm..." 
                                class="w-64 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-green-500 shadow-sm">
                        <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                    </div>
                    <a href="cart.html">
                        <button class="relative p-2 text-gray-700 hover:text-green-600">
                            <i class="fas fa-shopping-cart text-xl"></i>
                            <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                        </button>
                    </a>
                    <div id="user-info" class="flex items-center space-x-2"></div>
                </div>
                <button class="md:hidden p-2 rounded-full hover:bg-green-100">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-12">
        <nav class="text-sm mb-6">
            <a href="index.html" class="text-gray-500 hover:text-green-600">Trang chủ</a>
            <span class="mx-2">/</span>
            <span class="text-green-600 font-semibold">Thông tin cá nhân</span>
        </nav>

        <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-green-700 mb-8 flex items-center">
                <i class="fas fa-user-circle mr-3"></i> Hồ sơ của tôi
            </h1>
            
            <div id="alert-message" class="mb-4 hidden p-3 rounded-lg text-sm" role="alert"></div>

            <div class="grid md:grid-cols-3 gap-8">
                <div class="col-span-1 border-r border-gray-200 pr-8">
                    
                    <section class="mb-8 text-center">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center justify-center gap-2">
                             Ảnh đại diện
                        </h2>
                        <img id="profile-avatar" src="https://via.placeholder.com/120/10B981/FFFFFF?text=U" alt="Avatar" 
                             class="w-32 h-32 rounded-full object-cover border-4 border-green-400 shadow-lg mx-auto mb-4">
                        
                        <label for="avatar-input" class="cursor-pointer bg-green-500 text-white px-4 py-2 rounded-full hover:bg-green-600 transition text-sm">
                            <i class="fas fa-camera mr-2"></i> Chọn Ảnh
                        </label>
                        <input type="file" id="avatar-input" accept="image/*" class="hidden">
                        
                        <button id="update-avatar-btn" class="bg-blue-500 text-white px-4 py-2 rounded-full hover:bg-blue-600 transition text-sm mt-3 hidden">
                            <i class="fas fa-upload mr-2"></i> Lưu Avatar
                        </button>
                        <p id="avatar-status" class="text-xs mt-2 text-gray-500"></p>
                    </section>
                    
                    <hr class="my-6">

                    <section>
                        <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center gap-2">
                            <i class="fas fa-lock text-red-500"></i> Đổi mật khẩu
                        </h2>
                        <form id="password-form">
                            <div class="mb-3">
                                <input type="password" id="current-password" placeholder="Mật khẩu hiện tại" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                            <div class="mb-4">
                                <input type="password" id="new-password" placeholder="Mật khẩu mới (ít nhất 6 ký tự)" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                            <button type="submit" class="w-full bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition">
                                Đổi mật khẩu
                            </button>
                            <p id="password-status" class="text-xs text-center mt-2 text-red-500"></p>
                        </form>
                    </section>
                </div>

                <div class="md:col-span-2">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-2">Thông tin cơ bản & Giao hàng</h2>
                    <form id="profile-form">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                            <div>
                                <h3 class="font-semibold text-lg mb-3 text-green-600"><i class="fas fa-user mr-2"></i> Thông tin cá nhân</h3>
                                <div class="mb-4">
                                    <label for="email" class="block text-gray-700 font-medium mb-1">Email</label>
                                    <input type="email" id="email" name="email" readonly
                                        class="w-full px-4 py-2 border border-gray-300 bg-gray-50 rounded-lg cursor-not-allowed">
                                </div>
                                <div class="mb-4">
                                    <label for="displayName" class="block text-gray-700 font-medium mb-1">Tên hiển thị</label>
                                    <input type="text" id="displayName" name="displayName"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                        placeholder="Tên của bạn">
                                </div>
                                <div class="mb-4">
                                    <label for="gender" class="block text-gray-700 font-medium mb-1">Giới tính</label>
                                    <select id="gender" name="gender" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                        <option value="" disabled selected>Chọn giới tính</option>
                                        <option value="male">Nam</option>
                                        <option value="female">Nữ</option>
                                        <option value="other">Khác</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="font-semibold text-lg mb-3 text-green-600"><i class="fas fa-truck-fast mr-2"></i> Thông tin giao hàng</h3>
                                <div class="mb-4">
                                    <label for="phone" class="block text-gray-700 font-medium mb-1">Số điện thoại</label>
                                    <input type="tel" id="phone" name="phone"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                        placeholder="Số điện thoại của bạn">
                                </div>
                                <div class="mb-4">
                                    <label for="address" class="block text-gray-700 font-medium mb-1">Địa chỉ giao hàng</label>
                                    <textarea id="address" name="address" rows="5"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                        placeholder="Số nhà, tên đường, Phường/Xã, Quận/Huyện, Tỉnh/Thành phố"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-start mt-8 border-t pt-6">
                            <button type="submit" class="btn-primary px-8 py-3 rounded-full font-semibold">
                                <i class="fas fa-save mr-2"></i> Lưu thay đổi
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-12 mt-12">
        <div class="container mx-auto px-4">
            <div class="grid md:grid-cols-4 gap-8">
                <div>
                    <div class="flex items-center space-x-2 mb-4">
                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-leaf text-white"></i>
                        </div>
                        <span class="text-xl font-bold">Green Fresh</span>
                    </div>
                    <p class="text-gray-400 mb-4">
                        Cung cấp thực phẩm xanh sạch, an toàn cho sức khỏe gia đình Việt.
                    </p>
                    <div class="flex space-x-4">
                        <a href="https://facebook.com" class="text-gray-400 hover:text-white"><i class="fab fa-facebook"></i></a>
                        <a href="https://instagram.com" class="text-gray-400 hover:text-white"><i class="fab fa-instagram"></i></a>
                        <a href="https://youtube.com" class="text-gray-400 hover:text-white"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">Sản phẩm</h3>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="product.html" class="hover:text-white">Rau củ quả</a></li>
                        <li><a href="product.html" class="hover:text-white">Trái cây</a></li>
                        <li><a href="product.html" class="hover:text-white">Thịt sạch</a></li>
                        <li><a href="product.html" class="hover:text-white">Hải sản</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">Hỗ trợ</h3>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="forgotpassword.html" class="hover:text-white">Liên hệ</a></li>
                        <li><a href="index.html" class="hover:text-white">Chính sách đổi trả</a></li>
                        <li><a href="index.html" class="hover:text-white">Hướng dẫn mua hàng</a></li>
                        <li><a href="index.html" class="hover:text-white">FAQ</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">Liên hệ</h3>
                    <div class="space-y-2 text-gray-400">
                        <p><i class="fas fa-map-marker-alt mr-2"></i>123 Đường ABC, Quận 1, TP.HCM</p>
                        <p><i class="fas fa-phone mr-2"></i>0123 456 789</p>
                        <p><i class="fas fa-envelope mr-2"></i>info@greenfresh.vn</p>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
                <p>&copy; 2024 Green Fresh. Tất cả quyền được bảo lưu.</p>
            </div>
        </div>
    </footer>

    <script>
        // Cập nhật số lượng giỏ hàng trên icon
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const cartCount = document.getElementById('cart-count');
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0); 
            if (cartCount) cartCount.textContent = totalItems; 
        }
        updateCartCount();
        window.addEventListener('storage', updateCartCount);

        // Hàm hiển thị thông báo
        function showAlert(message, type) {
            const alertBox = document.getElementById('alert-message');
            alertBox.textContent = message;
            alertBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            
            if (type === 'success') {
                alertBox.classList.add('bg-green-100', 'text-green-800');
            } else {
                alertBox.classList.add('bg-red-100', 'text-red-800');
            }
            // Tự động ẩn sau 5 giây
            setTimeout(() => {
                alertBox.classList.add('hidden');
            }, 5000);
        }
        
        // Cập nhật thông tin người dùng trong Header
        function updateUserInfoHeader(user) {
             const userInfo = document.getElementById('user-info');
             userInfo.innerHTML = ''; // Xóa nội dung cũ
             
             if (user && user.email) {
                 const displayName = user.displayName || user.email.split('@')[0];
                 const avatarUrl = user.avatarUrl || 'https://via.placeholder.com/32/10B981/FFFFFF?text=U'; // Avatar mặc định
                
                 userInfo.innerHTML = `
                     <div class="relative group">
                         <button class="flex items-center p-2 text-green-700 hover:text-green-500 transition focus:outline-none">
                             <img src="${avatarUrl}" alt="Avatar" class="w-8 h-8 rounded-full border border-green-300 object-cover">
                             <span class="hidden md:inline text-base ml-1 font-semibold">${displayName}</span> 
                             <i class="fas fa-caret-down text-sm ml-1"></i>
                         </button>
                         
                         <div class="absolute right-0 mt-2 w-52 bg-white border border-gray-200 rounded-lg shadow-xl py-1 z-50 
                                     opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 
                                     transform scale-95 group-hover:scale-100 origin-top-right">
                             
                             <div class="px-4 py-2 text-gray-800 border-b border-gray-100 font-bold break-words text-sm">${user.email}</div>

                             <a href="profile.html" class="block px-4 py-2 text-gray-700 hover:bg-green-100 hover:text-green-600">
                                 <i class="fas fa-address-card mr-2"></i> Thông tin cá nhân
                             </a>
                             <a href="order-history.html" class="block px-4 py-2 text-gray-700 hover:bg-green-100 hover:text-green-600">
                                 <i class="fas fa-history mr-2"></i> Lịch sử đơn hàng
                             </a>
                             <hr class="my-1">
                             <button id="logoutBtn" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 hover:text-red-700">
                                 <i class="fas fa-sign-out-alt mr-2"></i> Đăng xuất
                             </button>
                         </div>
                     </div>
                 `;
                 
                 document.getElementById('logoutBtn').onclick = function() {
                     localStorage.removeItem('user');
                     localStorage.removeItem('token'); 
                     window.location.href = 'index.html'; 
                 };
             } else {
                 userInfo.innerHTML = `
                     <a href="login.html" class="bg-green-500 text-white px-4 py-2 rounded-full hover:bg-green-600 transition flex items-center justify-center">Đăng nhập</a>
                     <a href="register.html" class="bg-orange-500 text-white px-4 py-2 rounded-full hover:bg-orange-600 transition hidden sm:flex items-center justify-center">Đăng ký</a>
                 `;
             }
        }
        
        // ⭐️ LOGIC CẬP NHẬT AVATAR (Giả lập) ⭐️
        function setupAvatarUpdate(user) {
            const avatarImg = document.getElementById('profile-avatar');
            const avatarInput = document.getElementById('avatar-input');
            const updateAvatarBtn = document.getElementById('update-avatar-btn');
            const avatarStatus = document.getElementById('avatar-status');
            
            // Tải ảnh đại diện hiện tại
            avatarImg.src = user.avatarUrl || 'https://via.placeholder.com/120/10B981/FFFFFF?text=U';

            avatarInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        avatarImg.src = e.target.result;
                        updateAvatarBtn.classList.remove('hidden');
                        avatarStatus.textContent = 'Ảnh đã sẵn sàng. Nhấn "Lưu Avatar".';
                        avatarStatus.classList.remove('text-red-500', 'text-green-500');
                        avatarStatus.classList.add('text-blue-500');
                    };
                    reader.readAsDataURL(file);
                }
            });

            updateAvatarBtn.addEventListener('click', function() {
                // CHỨC NĂNG GIẢ LẬP: Lưu Data URL vào localStorage
                // Trong thực tế, bạn sẽ gửi file lên API server để lưu trữ.
                const newAvatarUrl = avatarImg.src; 
                
                // Cập nhật localStorage
                user.avatarUrl = newAvatarUrl;
                localStorage.setItem('user', JSON.stringify(user));
                
                updateAvatarBtn.classList.add('hidden');
                avatarStatus.textContent = 'Cập nhật Avatar thành công! 🎉';
                avatarStatus.classList.remove('text-red-500', 'text-blue-500');
                avatarStatus.classList.add('text-green-500');
                
                // Cập nhật lại header ngay lập tức
                updateUserInfoHeader(user);
            });
        }


        // ⭐️ LOGIC ĐỔI MẬT KHẨU ⭐️
        function setupPasswordUpdate(token) {
             document.getElementById('password-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const status = document.getElementById('password-status');
                status.textContent = 'Đang đổi mật khẩu...';
                status.classList.remove('text-red-500', 'text-green-500');
                status.classList.add('text-gray-500');

                const currentPass = document.getElementById('current-password').value;
                const newPass = document.getElementById('new-password').value;

                if (newPass.length < 6) {
                    status.textContent = 'Mật khẩu mới phải có ít nhất 6 ký tự.';
                    status.classList.remove('text-gray-500');
                    status.classList.add('text-red-500');
                    return;
                }
                
                fetch('https://exe-zjbe.onrender.com/api/user/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ currentPassword: currentPass, newPassword: newPass })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        status.textContent = 'Đổi mật khẩu thành công! Vui lòng đăng nhập lại.';
                        status.classList.remove('text-gray-500', 'text-red-500');
                        status.classList.add('text-green-500');
                        
                        // Xóa token và buộc đăng xuất sau 3 giây
                        setTimeout(() => {
                            localStorage.removeItem('user');
                            localStorage.removeItem('token');
                            window.location.href = 'login.html';
                        }, 3000);

                    } else {
                        status.textContent = data.message || 'Đổi mật khẩu thất bại. Kiểm tra mật khẩu hiện tại.';
                        status.classList.remove('text-gray-500', 'text-green-500');
                        status.classList.add('text-red-500');
                    }
                })
                .catch(error => {
                    console.error('Error changing password:', error);
                    status.textContent = 'Lỗi kết nối hoặc hệ thống. Vui lòng thử lại.';
                    status.classList.remove('text-gray-500', 'text-green-500');
                    status.classList.add('text-red-500');
                });
            });
        }

        // Logic chính để tải trang Profile và xử lý đăng nhập
        document.addEventListener('DOMContentLoaded', function() {
            const userLocalStorage = localStorage.getItem('user');
            const token = localStorage.getItem('token');
            let user = null;

            // Xử lý lỗi JSON khi đọc localStorage
            if (userLocalStorage) {
                try {
                    user = JSON.parse(userLocalStorage);
                } catch (e) {
                    localStorage.removeItem('user');
                    user = null;
                }
            }

            // Kiểm tra đăng nhập
            if (user && user.email && token) { 
                
                // --- 1. TẢI DỮ LIỆU VÀO FORM ---
                document.getElementById('email').value = user.email || '';
                document.getElementById('displayName').value = user.displayName || '';
                document.getElementById('phone').value = user.phone || '';
                document.getElementById('address').value = user.address || '';
                if (user.gender) {
                    document.getElementById('gender').value = user.gender;
                }

                // --- 2. XỬ LÝ HEADER ---
                updateUserInfoHeader(user);
                
                // --- 3. SETUP CHỨC NĂNG AVATAR & MẬT KHẨU ---
                setupAvatarUpdate(user);
                setupPasswordUpdate(token);

                // --- 4. XỬ LÝ SUBMIT PROFILE FORM ---
                document.getElementById('profile-form').onsubmit = function(e) {
                    e.preventDefault();
                    
                    const newDisplayName = document.getElementById('displayName').value;
                    const newPhone = document.getElementById('phone').value;
                    const newAddress = document.getElementById('address').value;
                    const newGender = document.getElementById('gender').value;

                    // Gửi thông tin lên Backend
                    fetch('https://exe-zjbe.onrender.com/api/users/update-profile', { 
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}` 
                        },
                        body: JSON.stringify({
                            email: user.email, // Gửi email để xác định người dùng
                            displayName: newDisplayName,
                            phone: newPhone,
                            address: newAddress,
                            gender: newGender
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            if (response.status === 401) {
                                localStorage.removeItem('user');
                                localStorage.removeItem('token');
                                alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                                window.location.href = 'login.html';
                            }
                            return response.json().then(err => { throw new Error(err.message || 'Lỗi cập nhật hồ sơ'); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Cập nhật lại localStorage sau khi cập nhật thành công
                        const updatedUser = { 
                            ...user, 
                            displayName: newDisplayName, 
                            phone: newPhone, 
                            address: newAddress, 
                            gender: newGender 
                        };
                        localStorage.setItem('user', JSON.stringify(updatedUser));
                        
                        showAlert('Cập nhật hồ sơ thành công! (Tên, SĐT, Địa chỉ)', 'success');
                        
                        // Cập nhật lại tên hiển thị trên header
                        updateUserInfoHeader(updatedUser);
                    })
                    .catch(error => {
                        console.error('Lỗi khi cập nhật hồ sơ:', error);
                        showAlert(error.message || 'Đã xảy ra lỗi trong quá trình cập nhật.', 'error');
                    });
                };

            } else {
                // Xử lý trường hợp chưa đăng nhập
                alert('Bạn cần đăng nhập để xem trang thông tin cá nhân.');
                window.location.href = 'login.html'; 
            }
        });
    </script>
</body>
</html>