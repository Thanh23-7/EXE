<script>
    // --- MOCK API (Gi·∫£ l·∫≠p Backend) ---
    const usersDB = JSON.parse(localStorage.getItem('usersDB') || '[]');
    
    function mockApiUpdateProfile(email, newDisplayName) {
        return new Promise(resolve => {
            setTimeout(() => {
                const userIndex = usersDB.findIndex(u => u.email === email);
                if (userIndex > -1) {
                    // C·∫≠p nh·∫≠t trong DB gi·∫£ ƒë·ªãnh
                    usersDB[userIndex].displayName = newDisplayName;
                    localStorage.setItem('usersDB', JSON.stringify(usersDB));
                    
                    // Tr·∫£ v·ªÅ th√†nh c√¥ng
                    resolve({ success: true });
                } else {
                    resolve({ success: false, error: 'T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i.' });
                }
            }, 500); // Gi·∫£ l·∫≠p ƒë·ªô tr·ªÖ m·∫°ng 500ms
        });
    }

    function mockApiChangePassword(email, currentPassword, newPassword) {
        return new Promise(resolve => {
            setTimeout(() => {
                const user = usersDB.find(u => u.email === email);
                if (!user) {
                    return resolve({ success: false, error: 'T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i.' });
                }

                // Gi·∫£ l·∫≠p ki·ªÉm tra m·∫≠t kh·∫©u hi·ªán t·∫°i
                if (user.password !== currentPassword) {
                    return resolve({ success: false, error: 'M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng.' });
                }

                if (currentPassword === newPassword) {
                    return resolve({ success: false, error: 'M·∫≠t kh·∫©u m·ªõi ph·∫£i kh√°c m·∫≠t kh·∫©u c≈©.' });
                }

                // C·∫≠p nh·∫≠t m·∫≠t kh·∫©u trong DB gi·∫£ ƒë·ªãnh
                user.password = newPassword;
                localStorage.setItem('usersDB', JSON.stringify(usersDB));

                resolve({ success: true });
            }, 500);
        });
    }
    // --- K·∫æT TH√öC MOCK API ---


    const profileMsgEl = document.getElementById('profile-msg');
    const emailInput = document.getElementById('email');
    const displayNameInput = document.getElementById('displayName');
    const currentPasswordInput = document.getElementById('currentPassword');
    const newPasswordInput = document.getElementById('newPassword');
    const updateBtn = document.querySelector('#updateProfile button[type="submit"]');
    const changePassBtn = document.querySelector('#changePassword button[type="submit"]');

    // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
    let user = JSON.parse(localStorage.getItem('user') || 'null');
    if (!user) {
        window.location.href = 'login.html';
    }

    // Hi·ªÉn th·ªã th√¥ng tin c√° nh√¢n
    emailInput.value = user.email;
    displayNameInput.value = user.displayName || user.email.split('@')[0]; // D√πng email n·∫øu ch∆∞a c√≥ t√™n hi·ªÉn th·ªã
    
    /**
     * Hi·ªÉn th·ªã th√¥ng b√°o v√† ƒë·∫∑t m√†u s·∫Øc (th√†nh c√¥ng: xanh, l·ªói: ƒë·ªè)
     */
    function showMessage(message, isSuccess = true) {
        profileMsgEl.textContent = message;
        profileMsgEl.className = `mt-4 text-center font-semibold ${isSuccess ? 'text-green-600' : 'text-red-600'}`;
    }

    // --- C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n ---
    document.getElementById('updateProfile').onsubmit = async function(e) {
        e.preventDefault();
        profileMsgEl.textContent = '';
        
        const newDisplayName = displayNameInput.value.trim();

        if (newDisplayName.length < 3) {
            return showMessage('T√™n hi·ªÉn th·ªã ph·∫£i √≠t nh·∫•t 3 k√Ω t·ª±.', false);
        }

        // Ki·ªÉm tra n·∫øu kh√¥ng c√≥ g√¨ thay ƒë·ªïi
        if (newDisplayName === user.displayName) {
            return showMessage('Kh√¥ng c√≥ th√¥ng tin n√†o ƒë∆∞·ª£c thay ƒë·ªïi.', true);
        }

        // B·∫Øt ƒë·∫ßu Loading
        updateBtn.textContent = 'ƒêang c·∫≠p nh·∫≠t...';
        updateBtn.disabled = true;

        // Gi·∫£ l·∫≠p g·ªçi API thay v√¨ fetch('/api/update-profile', ...)
        const data = await mockApiUpdateProfile(user.email, newDisplayName);

        // K·∫øt th√∫c Loading
        updateBtn.textContent = 'C·∫≠p nh·∫≠t th√¥ng tin';
        updateBtn.disabled = false;

        if (data.success) {
            // C·∫≠p nh·∫≠t user trong localStorage (Frontend)
            user.displayName = newDisplayName;
            localStorage.setItem('user', JSON.stringify(user));
            showMessage('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng! üéâ', true);
        } else {
            showMessage(data.error || 'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t!', false);
        }
    };

    // --- ƒê·ªïi m·∫≠t kh·∫©u ---
    document.getElementById('changePassword').onsubmit = async function(e) {
        e.preventDefault();
        profileMsgEl.textContent = '';

        const currentPassword = currentPasswordInput.value;
        const newPassword = newPasswordInput.value;

        // Validation c∆° b·∫£n
        if (!currentPassword || !newPassword) {
            return showMessage('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß M·∫≠t kh·∫©u hi·ªán t·∫°i v√† M·∫≠t kh·∫©u m·ªõi.', false);
        }
        if (newPassword.length < 6) {
            return showMessage('M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±.', false);
        }

        // B·∫Øt ƒë·∫ßu Loading
        changePassBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
        changePassBtn.disabled = true;

        // Gi·∫£ l·∫≠p g·ªçi API thay v√¨ fetch('/api/change-password', ...)
        const data = await mockApiChangePassword(user.email, currentPassword, newPassword);

        // K·∫øt th√∫c Loading
        changePassBtn.textContent = 'ƒê·ªïi m·∫≠t kh·∫©u';
        changePassBtn.disabled = false;

        if (data.success) {
            showMessage('ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i l·∫ßn sau v·ªõi m·∫≠t kh·∫©u m·ªõi.', true);
            // X√≥a n·ªôi dung form sau khi th√†nh c√¥ng
            currentPasswordInput.value = '';
            newPasswordInput.value = '';
        } else {
            showMessage(data.error || 'ƒê·ªïi m·∫≠t kh·∫©u th·∫•t b·∫°i.', false);
        }
    };
</script>