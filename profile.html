<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√¥ng tin C√° nh√¢n - Organic Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .btn-primary {
            background-color: #10B981; /* green-500 */
            transition: background-color 0.15s;
        }
        .btn-primary:hover {
            background-color: #059669; /* green-600 */
        }
    </style>
</head>
<body class="bg-gray-50">

    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-green-600">Organic Shop üåæ</h1>
            <nav>
                <a href="product.html" class="text-gray-700 hover:text-green-600 transition">S·∫£n ph·∫©m</a>
                <a href="cart.html" class="ml-4 text-gray-700 hover:text-green-600 transition">Gi·ªè h√†ng</a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-12">
        <div class="max-w-3xl mx-auto bg-white p-8 md:p-12 rounded-xl shadow-2xl">
            <h2 class="text-4xl font-extrabold text-gray-800 mb-8 text-center border-b pb-4">
                Th√¥ng Tin T√†i Kho·∫£n
            </h2>

            <div id="profile-msg" class="mt-4 text-center font-semibold">
                </div>

            <section class="mb-10 p-6 border border-gray-100 rounded-lg bg-gray-50">
                <h3 class="text-2xl font-bold text-green-700 mb-6 flex items-center">
                    <i class="fas fa-user-edit mr-3"></i> C·∫≠p nh·∫≠t Profile
                </h3>
                <form id="updateProfile">
                    <div class="mb-4">
                        <label for="email" class="block text-gray-700 font-semibold mb-2">Email (Kh√¥ng th·ªÉ thay ƒë·ªïi)</label>
                        <input type="email" id="email" class="w-full border border-gray-300 p-3 rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                    </div>
                    <div class="mb-6">
                        <label for="displayName" class="block text-gray-700 font-semibold mb-2">T√™n hi·ªÉn th·ªã</label>
                        <input type="text" id="displayName" placeholder="Nh·∫≠p t√™n hi·ªÉn th·ªã c·ªßa b·∫°n" required class="w-full border border-gray-300 p-3 rounded-lg focus:border-green-500 focus:ring-green-500">
                    </div>
                    <button type="submit" class="btn-primary w-full text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md">
                        C·∫≠p nh·∫≠t th√¥ng tin
                    </button>
                </form>
            </section>

            <section class="p-6 border border-gray-100 rounded-lg bg-gray-50">
                <h3 class="text-2xl font-bold text-red-600 mb-6 flex items-center">
                    <i class="fas fa-key mr-3"></i> ƒê·ªïi M·∫≠t kh·∫©u
                </h3>
                <form id="changePassword">
                    <div class="mb-4">
                        <label for="currentPassword" class="block text-gray-700 font-semibold mb-2">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                        <input type="password" id="currentPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i" required class="w-full border border-gray-300 p-3 rounded-lg focus:border-red-500 focus:ring-red-500">
                    </div>
                    <div class="mb-6">
                        <label for="newPassword" class="block text-gray-700 font-semibold mb-2">M·∫≠t kh·∫©u m·ªõi</label>
                        <input type="password" id="newPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (√≠t nh·∫•t 6 k√Ω t·ª±)" required class="w-full border border-gray-300 p-3 rounded-lg focus:border-red-500 focus:ring-red-500">
                    </div>
                    <button type="submit" class="bg-red-500 hover:bg-red-600 w-full text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md" id="changePassBtn">
                        ƒê·ªïi m·∫≠t kh·∫©u
                    </button>
                </form>
            </section>

        </div>
    </main>

    <footer class="bg-gray-800 text-white mt-12 py-6 text-center">
        <p>&copy; 2024 Organic Shop. B·∫£o m·∫≠t & ƒêi·ªÅu kho·∫£n.</p>
    </footer>

    <script>
        // --- KHAI B√ÅO C·∫§U H√åNH API TH·∫¨T ---
        // S·ª¨ D·ª§NG BASE URL CHO T·∫§T C·∫¢ C√ÅC G·ªåI API
        const API_BASE_URL = 'https://exe-zjbe.onrender.com/api'; 
        
        // ‚≠êÔ∏è FIX: CH·ªàNH S·ª¨A H√ÄM G·ªåI API ƒê·ªÇ KH·ªöP V·ªöI server.js (D√πng email, kh√¥ng d√πng userId) ‚≠êÔ∏è

        // --- H√ÄM G·ªåI API TH·∫¨T: C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n (POST /api/update-profile) ---
        async function updateProfile(email, newDisplayName) {
            try {
                // G·ªåI API ƒê√öNG THEO SERVER.JS: POST /api/update-profile 
                const response = await fetch(`${API_BASE_URL}/update-profile`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // TRUY·ªÄN email V√Ä displayName
                    body: JSON.stringify({ email: email, displayName: newDisplayName }) 
                });
    
                const data = await response.json();
    
                if (!data.success) {
                    throw new Error(data.error || 'C·∫≠p nh·∫≠t th·∫•t b·∫°i.');
                }
                
                // Tr·∫£ v·ªÅ th√†nh c√¥ng
                return { success: true, updatedUser: { displayName: newDisplayName } }; 
    
            } catch (error) {
                console.error("L·ªói c·∫≠p nh·∫≠t profile:", error);
                return { success: false, error: error.message || 'L·ªói k·∫øt n·ªëi m√°y ch·ªß.' };
            }
        }
    
        // --- H√ÄM G·ªåI API TH·∫¨T: ƒê·ªïi m·∫≠t kh·∫©u (POST /api/change-password) ---
        async function changePassword(email, currentPassword, newPassword) {
            try {
                // G·ªåI API ƒê√öNG THEO SERVER.JS: POST /api/change-password 
                const response = await fetch(`${API_BASE_URL}/change-password`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // TRUY·ªÄN email, currentPassword, newPassword
                    body: JSON.stringify({ email: email, currentPassword, newPassword }) 
                });
    
                const data = await response.json();
    
                if (!data.success) {
                    // Backend tr·∫£ v·ªÅ message l·ªói c·ª• th·ªÉ n·∫øu m·∫≠t kh·∫©u c≈© sai
                    throw new Error(data.error || 'ƒê·ªïi m·∫≠t kh·∫©u th·∫•t b·∫°i.');
                }
    
                return { success: true }; 
    
            } catch (error) {
                console.error("L·ªói ƒë·ªïi m·∫≠t kh·∫©u:", error);
                return { success: false, error: error.message || 'L·ªói k·∫øt n·ªëi m√°y ch·ªß.' };
            }
        }
        // --- K·∫æT TH√öC H√ÄM API TH·∫¨T ƒê√É FIX ---
    
    
        const profileMsgEl = document.getElementById('profile-msg');
        const emailInput = document.getElementById('email');
        const displayNameInput = document.getElementById('displayName');
        const currentPasswordInput = document.getElementById('currentPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const updateBtn = document.querySelector('#updateProfile button[type="submit"]');
        const changePassBtn = document.querySelector('#changePassword button[type="submit"]');
    
        // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        let user = JSON.parse(localStorage.getItem('user') || 'null');
        
        // Chuy·ªÉn h∆∞·ªõng n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c thi·∫øu th√¥ng tin quan tr·ªçng
        // Lo·∫°i b·ªè ki·ªÉm tra token v√¨ Backend hi·ªán t·∫°i ch·ªâ d√πng email/password cho form n√†y
        if (!user || !user.email) { 
            window.location.href = 'login.html';
            return; 
        }
    
        // Hi·ªÉn th·ªã th√¥ng tin c√° nh√¢n
        emailInput.value = user.email;
        displayNameInput.value = user.displayName || user.email.split('@')[0];
        
        /**
         * Hi·ªÉn th·ªã th√¥ng b√°o v√† ƒë·∫∑t m√†u s·∫Øc (th√†nh c√¥ng: xanh, l·ªói: ƒë·ªè)
         */
        function showMessage(message, isSuccess = true) {
            profileMsgEl.textContent = message;
            profileMsgEl.className = `mt-4 text-center font-semibold ${isSuccess ? 'text-green-600' : 'text-red-600'}`;
        }
    
        // --- X·ª≠ l√Ω C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n ---
        document.getElementById('updateProfile').onsubmit = async function(e) {
            e.preventDefault();
            profileMsgEl.textContent = '';
            
            const newDisplayName = displayNameInput.value.trim();
    
            if (newDisplayName.length < 3) {
                return showMessage('T√™n hi·ªÉn th·ªã ph·∫£i √≠t nh·∫•t 3 k√Ω t·ª±.', false);
            }
    
            if (newDisplayName === user.displayName) {
                return showMessage('Kh√¥ng c√≥ th√¥ng tin n√†o ƒë∆∞·ª£c thay ƒë·ªïi.', true);
            }
    
            // B·∫Øt ƒë·∫ßu Loading
            updateBtn.textContent = 'ƒêang c·∫≠p nh·∫≠t...';
            updateBtn.disabled = true;
    
            // G·ªåI API TH·∫¨T (D√πng email)
            const data = await updateProfile(user.email, newDisplayName);
    
            // K·∫øt th√∫c Loading
            updateBtn.textContent = 'C·∫≠p nh·∫≠t th√¥ng tin';
            updateBtn.disabled = false;
    
            if (data.success) {
                // C·∫≠p nh·∫≠t user trong localStorage (Frontend)
                user.displayName = data.updatedUser.displayName; 
                localStorage.setItem('user', JSON.stringify(user));
                showMessage('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng! üéâ', true);
            } else {
                showMessage(data.error || 'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t!', false);
            }
        };
    
        // --- X·ª≠ l√Ω ƒê·ªïi m·∫≠t kh·∫©u ---
        document.getElementById('changePassword').onsubmit = async function(e) {
            e.preventDefault();
            profileMsgEl.textContent = '';
    
            const currentPassword = currentPasswordInput.value;
            const newPassword = newPasswordInput.value;
    
            // Validation c∆° b·∫£n
            if (!currentPassword || !newPassword) {
                return showMessage('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß M·∫≠t kh·∫©u hi·ªán t·∫°i v√† M·∫≠t kh·∫©u m·ªõi.', false);
            }
            if (newPassword.length < 6) {
                return showMessage('M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±.', false);
            }
    
            // B·∫Øt ƒë·∫ßu Loading
            changePassBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
            changePassBtn.disabled = true;
    
            // G·ªåI API TH·∫¨T (D√πng email)
            const data = await changePassword(user.email, currentPassword, newPassword);
    
            // K·∫øt th√∫c Loading
            changePassBtn.textContent = 'ƒê·ªïi m·∫≠t kh·∫©u';
            changePassBtn.disabled = false;
    
            if (data.success) {
                // Thao t√°c b·∫£o m·∫≠t: Y√™u c·∫ßu ƒëƒÉng nh·∫≠p l·∫°i sau khi ƒë·ªïi m·∫≠t kh·∫©u
                showMessage('ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', true);
                
                currentPasswordInput.value = '';
                newPasswordInput.value = '';
    
                // T·ª± ƒë·ªông Logout sau 2 gi√¢y
                setTimeout(() => {
                    localStorage.removeItem('user');
                    localStorage.removeItem('token'); // X√≥a token
                    window.location.href = 'login.html'; // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ƒëƒÉng nh·∫≠p
                }, 2000); 
            } else {
                showMessage(data.error || 'ƒê·ªïi m·∫≠t kh·∫©u th·∫•t b·∫°i.', false);
            }
        };
    </script>
</body>
</html>