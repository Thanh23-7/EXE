<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng - Green Fresh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .bg-gradient-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .card {
            border-radius: 1rem;
            box-shadow: 0 2px 12px rgba(16,185,129,0.08);
            transition: box-shadow 0.3s;
        }
        .card:hover {
            box-shadow: 0 8px 32px rgba(16,185,129,0.18);
        }
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(16,185,129,0.15);
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 8px 24px rgba(16,185,129,0.25);
        }
        /* Style cho nút thanh toán */
        #checkoutBtn, #vnpayBtn {
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; /* rounded-full */
            transition: all 0.2s ease-in-out;
        }
        #checkoutBtn:hover { background-color: #059669; } /* green-600 */
        #vnpayBtn:hover { background-color: #3b82f6; } /* blue-600 */
    </style>
</head>
<body class="bg-gray-50">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <a href="index.html" class="flex items-center space-x-2">
                <div class="w-10 h-10 bg-gradient-green rounded-full flex items-center justify-center shadow-lg">
                    <i class="fas fa-leaf text-white text-xl"></i>
                </div>
                <span class="text-2xl font-extrabold text-green-600 tracking-wide">Green Fresh</span>
            </a>
            <nav class="hidden md:flex space-x-8">
                <a href="index.html" class="text-gray-700 hover:text-green-600 font-semibold transition">Trang chủ</a>
                <a href="product.html" class="text-gray-700 hover:text-green-600 font-semibold transition">Sản phẩm</a>
                <a href="about-us.html" class="text-gray-700 hover:text-green-600 font-semibold transition">Về chúng tôi</a>
                <a href="contact.html" class="text-gray-700 hover:text-green-600 font-semibold transition">Liên hệ</a>
            </nav>
            <a href="cart.html" class="relative p-2 text-gray-700 hover:text-green-600">
                <i class="fas fa-shopping-cart text-xl"></i>
                <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
            </a>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-6">Giỏ hàng của bạn</h1>
        
        <div id="cart-items" class="space-y-6">
        </div>

        <div id="cart-empty" class="text-gray-500 text-center text-xl mt-12 hidden">
            <i class="fas fa-box-open text-3xl mb-4"></i>
            <p>Giỏ hàng của bạn đang trống. Hãy thêm sản phẩm yêu thích vào nhé!</p>
        </div>

        <div class="mt-8 pt-4 border-t border-gray-200">
            <div id="cart-total" class="text-right text-3xl font-extrabold text-gray-800"></div>
            
            <div class="text-right mt-6 flex justify-end space-x-4">
                <button id="checkoutBtn" class="bg-green-500 text-white hover:bg-green-600 transition">Thanh toán khi nhận hàng</button>
                <button id="vnpayBtn" class="bg-blue-500 text-white hover:bg-blue-600 transition">Thanh toán VNPay</button>
            </div>
        </div>
    </main>

    <script>
        // *** ĐỊNH NGHĨA BASE URL CHO BACKEND ***
        const API_BASE_URL = 'https://exe-zjbe.onrender.com'; 
        
        // --- HÀM CƠ BẢN ---

        function calculateCartTotal(cart) {
            return cart.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);
        }

        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const cartCount = document.getElementById('cart-count');
            if (cartCount) cartCount.textContent = cart.length; 
        }

        function renderCart() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const cartItems = document.getElementById('cart-items');
            const cartEmpty = document.getElementById('cart-empty');
            const cartTotal = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkoutBtn');
            const vnpayBtn = document.getElementById('vnpayBtn');
            
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartEmpty.classList.remove('hidden');
                cartTotal.textContent = 'Tổng cộng: 0đ';
                checkoutBtn.style.display = 'none';
                vnpayBtn.style.display = 'none';
                return;
            } else {
                cartEmpty.classList.add('hidden');
                checkoutBtn.style.display = 'inline-block';
                vnpayBtn.style.display = 'inline-block';
            }
            
            let total = 0;
            
            cart.forEach((item, idx) => {
                const finalPrice = parseFloat(item.price || 0);
                total += finalPrice;
                
                // Sử dụng dấu ngoặc kép bên ngoài và template literal bên trong
                cartItems.innerHTML += `
                    <div class="bg-white card p-6 flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div>
                                <h3 class="font-semibold text-lg mb-1 text-gray-800">${item.name}</h3>
                                <p class="text-green-600 font-bold text-xl">${finalPrice.toLocaleString('vi-VN')}đ</p>
                            </div>
                        </div>
                        <button onclick="removeFromCart(${idx})" class="bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-600 transition flex items-center space-x-2 text-sm">
                            <i class="fas fa-trash-alt"></i>
                            <span>Xóa</span>
                        </button>
                    </div>
                `;
            });
            
            cartTotal.textContent = `Tổng cộng: ${total.toLocaleString('vi-VN')}đ`;
        }

        window.removeFromCart = function(idx) {
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');
            cart.splice(idx, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            renderCart();
        }; // Thêm dấu chấm phẩy

        // --- HÀM XỬ LÝ THANH TOÁN (KIỂM TRA ĐĂNG NHẬP) ---
        
        function handleCheckout(method) {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            
            if (cart.length === 0) {
                alert('Giỏ hàng trống! Vui lòng thêm sản phẩm.');
                return false;
            }

            if (!user || !user.email) { // Kiểm tra user.email để chắc chắn user hợp lệ
                alert('Vui lòng đăng nhập để tiến hành thanh toán.');
                window.location.href = 'login.html'; 
                return false;
            }
            
            return { cart, user, total: calculateCartTotal(cart) };
        }

        // --- XỬ LÝ SỰ KIỆN NÚT THANH TOÁN COD ---
        document.getElementById('checkoutBtn').onclick = function() {
            const checkoutData = handleCheckout('COD');
            if (!checkoutData) return; 

            const { cart } = checkoutData;

            // Giả lập lưu đơn hàng COD vào localStorage
            let orders = JSON.parse(localStorage.getItem('orders') || '[]');
            orders.push({
                items: cart,
                date: new Date().toLocaleString(),
                method: 'Thanh toán khi nhận hàng (COD)',
                total: calculateCartTotal(cart)
            });
            localStorage.setItem('orders', JSON.stringify(orders));
            localStorage.setItem('cart', '[]'); 
            
            renderCart();
            updateCartCount();
            alert('Đặt hàng thành công! Đơn hàng COD đã được lưu vào lịch sử. Cảm ơn bạn đã tin tưởng Green Fresh.');
            window.location.href = 'index.html'; 
        }; // Thêm dấu chấm phẩy

        // --- XỬ LÝ SỰ KIỆN NÚT THANH TOÁN VNPAY (ĐÃ FIX LỖI 404) ---
        document.getElementById('vnpayBtn').onclick = function() {
            const checkoutData = handleCheckout('VNPAY');
            if (!checkoutData) return; 
            
            const { user, total } = checkoutData;

            // GỌI API VỚI URL TUYỆT ĐỐI ĐỂ TRÁNH LỖI 404 TRÊN NETLIFY
            fetch(`${API_BASE_URL}/api/vnpay/create_payment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    // VNPay yêu cầu số nguyên (round total)
                    amount: Math.round(total), 
                    orderId: 'ORDER' + Date.now(),
                    orderInfo: `Thanh toán đơn hàng cho ${user.email}`
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.paymentUrl) {
                    window.location.href = data.paymentUrl;
                } else {
                    alert('Không tạo được link thanh toán VNPAY! Vui lòng kiểm tra log Backend.');
                }
            })
            .catch(error => {
                console.error("Lỗi khi gọi API VNPay:", error);
                alert('Có lỗi xảy ra khi kết nối thanh toán. Vui lòng kiểm tra console log.');
            });
        }; // Thêm dấu chấm phẩy

        // --- KHỞI TẠO ---
        document.addEventListener('DOMContentLoaded', function() {
            renderCart();
            updateCartCount();
        });
        window.addEventListener('storage', updateCartCount);
        window.addEventListener('storage', renderCart);
    </script>
</body>
</html>