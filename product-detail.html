<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết sản phẩm - Green Fresh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS cho các tab */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { border-color: #10B981; color: #10B981; font-weight: 600; }

        /* CSS cho timeline (Hành trình sản phẩm) */
        .timeline-item { position: relative; padding-left: 20px; border-left: 2px solid #E5E7EB; }
        .timeline-item:last-child { border-left: none; }
        .timeline-dot {
            position: absolute; left: -7px; top: 0;
            width: 14px; height: 14px;
            background-color: #10B981; border-radius: 50%;
            border: 2px solid white; 
        }
    </style>
</head>
<body class="bg-gray-50">

    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-green-700">Green Fresh</h1>
            <div class="flex items-center space-x-4">
                <a href="index.html" class="text-gray-600 hover:text-green-600">Trang chủ</a>
                <span id="user-display" class="text-sm text-gray-500"></span>
                <span class="relative">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </span>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        
        <nav class="text-sm text-gray-500 mb-6">
            <a href="index.html" class="hover:text-green-600">Trang chủ</a> / 
            <span id="breadcrumb-product-name" class="font-medium text-green-700">Tên Sản Phẩm</span>
        </nav>

        <section class="bg-white p-6 rounded-xl shadow-lg">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <div class="relative">
                    <img id="mainImage" src="https://via.placeholder.com/500x400/10b981/ffffff?text=Product" alt="Ảnh Sản Phẩm" class="w-full h-auto rounded-lg shadow-md object-cover">
                    </div>

                <div>
                    <h1 id="product-name-detail" class="text-3xl font-bold text-gray-900 mb-2">Tên Sản Phẩm Đang Tải...</h1>
                    
                    <div class="flex items-center mb-4">
                        <span class="text-yellow-500 text-xl mr-2">★★★★☆</span>
                        <span class="text-gray-600">(<span id="review-count">0</span> đánh giá)</span>
                    </div>

                    <div class="mb-6 flex items-center space-x-4">
                        <span id="current-price" class="text-4xl font-extrabold text-green-600">55.000 VNĐ</span>
                        <span id="old-price" class="text-xl text-gray-400 line-through">70.000 VNĐ</span>
                        <span class="bg-red-100 text-red-800 text-sm font-semibold px-2.5 py-0.5 rounded">Giảm 20%</span>
                    </div>

                    <p id="product-description" class="text-gray-700 mb-6 border-l-4 border-green-500 pl-3">Mô tả ngắn của sản phẩm...</p>

                    <div class="border p-4 rounded-lg mb-6">
                        <h3 class="font-bold text-lg mb-3 text-gray-800">Thông tin sản phẩm</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            </div>
                        <p class="text-sm text-gray-600 mt-4 text-right">
                            Còn lại: <span class="font-medium text-green-700">0</span> sản phẩm
                        </p>
                    </div>

                    <div class="flex items-center space-x-4 mb-8">
                        <div class="flex border rounded-lg overflow-hidden">
                            <button onclick="changeQuantity(-1)" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold">-</button>
                            <input type="number" id="quantityInput" value="1" min="1" class="w-16 text-center border-none focus:ring-0" readonly>
                            <button onclick="changeQuantity(1)" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold">+</button>
                        </div>
                        <button onclick="addToCart()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200">
                            Thêm vào giỏ hàng
                        </button>
                    </div>

                </div>
            </div>
        </section>

        <section class="mt-10 bg-white p-6 rounded-xl shadow-lg">
            
            <div class="flex border-b border-gray-200">
                <button data-target="description-content" class="tab-button active px-4 py-2 border-b-2 border-transparent text-gray-600 hover:border-green-500 transition duration-150 mr-4">
                    Mô tả chi tiết
                </button>
                <button data-target="journey-content" class="tab-button px-4 py-2 border-b-2 border-transparent text-gray-600 hover:border-green-500 transition duration-150 mr-4">
                    Hành trình sản phẩm
                </button>
                <button data-target="review-content" class="tab-button px-4 py-2 border-b-2 border-transparent text-gray-600 hover:border-green-500 transition duration-150">
                    Đánh giá (<span id="review-count-tab">0</span>)
                </button>
            </div>

            <div class="mt-5">
                <div id="description-content" class="tab-content active py-4">
                    <p class="text-gray-500">Đang tải mô tả chi tiết...</p>
                </div>

                <div id="journey-content" class="tab-content py-4">
                    <div id="journey-timeline" class="relative">
                        <div class="text-center text-gray-500 py-10">Đang tải thông tin hành trình...</div>
                    </div>
                </div>

                <div id="review-content" class="tab-content py-4">
                    <h3 class="text-xl font-bold mb-4">Viết đánh giá của bạn</h3>
                    <form id="review-form" class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <label for="review-rating" class="text-gray-700">Mức độ hài lòng:</label>
                            <select id="review-rating" class="border rounded-lg p-2 focus:ring-green-500 focus:border-green-500">
                                <option value="5">★★★★★ Tuyệt vời</option>
                                <option value="4">★★★★☆ Rất tốt</option>
                                <option value="3">★★★☆☆ Khá tốt</option>
                                <option value="2">★★☆☆☆ Tạm được</option>
                                <option value="1">★☆☆☆☆ Không hài lòng</option>
                            </select>
                        </div>
                        <textarea id="review-comment" rows="4" class="w-full border rounded-lg p-3 focus:ring-green-500 focus:border-green-500" placeholder="Viết đánh giá chi tiết của bạn về sản phẩm..."></textarea>
                        <div class="flex justify-between items-center">
                            <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-semibold transition duration-200">Gửi đánh giá</button>
                            <p id="review-message" class="hidden text-sm"></p>
                        </div>
                    </form>
                    
                    <h3 class="text-xl font-bold mt-8 mb-4 border-t pt-4">Các đánh giá gần đây</h3>
                    <div id="review-list" class="space-y-4">
                        </div>
                </div>
            </div>
        </section>

        <section class="mt-10">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Sản phẩm gợi ý cho bạn</h2>
            <div id="recommend-products" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                </div>
        </section>

    </main>

    <footer class="bg-gray-800 text-white mt-10 p-6 text-center">
        <p>&copy; 2024 Green Fresh. All rights reserved.</p>
    </footer>

    <script>
        // --- Global Variables and Utils ---
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        let productData = null; 
        
        // ⭐️ THAY THẾ BẰNG URL BACKEND RENDER CỦA BẠN ⭐️
        const API_BASE_URL = 'https://exe-zjbe.onrender.com'; 

        // Hàm format tiền tệ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }
        
        // Chức năng thay đổi số lượng
        let quantity = 1;
        function changeQuantity(change) {
            const input = document.getElementById('quantityInput');
            quantity = parseInt(input.value) + change;
            if (quantity < 1) quantity = 1;
            input.value = quantity;
        }
        
        // Chức năng chuyển đổi tab
        function setupTabs() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    // Xóa active khỏi tất cả các nút và nội dung
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                    // Thêm active cho nút và nội dung tương ứng
                    this.classList.add('active');
                    const targetId = this.getAttribute('data-target');
                    document.getElementById(targetId).classList.add('active');
                });
            });
            // Đảm bảo tab đầu tiên active khi load
            document.getElementById('description-content').classList.add('active');
        }

        // --- API Calls ---

        // 0. Load Product Details (ĐÃ FIX LỖI THÔNG TIN CHI TIẾT VÀ API)
        async function loadProductDetails() {
            if (!productId) {
                 document.getElementById('product-name-detail').textContent = 'Lỗi: Không tìm thấy ID sản phẩm';
                 document.getElementById('product-description').textContent = 'Vui lòng quay lại trang chủ.';
                 return;
            }

            try {
                // FIX: Thêm /api/ để gọi đúng endpoint trong server.js
                const response = await fetch(`${API_BASE_URL}/api/products/${productId}`); 
                
                const descriptionContentDiv = document.getElementById('description-content');
                const reviewCountTab = document.getElementById('review-count-tab');

                if (response.ok) {
                    productData = await response.json();
                    
                    // 1. Tiêu đề trang và Breadcrumb
                    document.title = `${productData.name} - Green Fresh`;
                    document.getElementById('breadcrumb-product-name').textContent = productData.name;
                    
                    // 2. Thông tin chính
                    document.getElementById('product-name-detail').textContent = productData.name;
                    document.getElementById('product-description').textContent = productData.description;
                    
                    // 3. Giá
                    const currentPrice = productData.price;
                    // Giá cũ đã có trong DB, nếu không có thì giả định
                    const oldPrice = productData.old_price || currentPrice * 1.2; 
                    const discountPercentage = Math.round(((oldPrice - currentPrice) / oldPrice) * 100);
                    
                    document.getElementById('current-price').textContent = formatCurrency(currentPrice);
                    document.getElementById('old-price').textContent = formatCurrency(oldPrice);
                    document.querySelector('.bg-red-100.text-red-800').textContent = `Giảm ${discountPercentage}%`;

                    // 4. Hình ảnh
                    // Sử dụng trường 'image' theo cấu trúc DB của bạn
                    const mainImageUrl = productData.image || `https://via.placeholder.com/500x400/10b981/ffffff?text=${productData.name}`; 
                    document.getElementById('mainImage').src = mainImageUrl;
                    document.getElementById('mainImage').alt = productData.name;

                    // 5. Thông tin sản phẩm chi tiết (Xuất xứ, Trọng lượng,...)
                    const productInfoDiv = document.querySelector('.grid.grid-cols-2.gap-4.text-sm');
                    productInfoDiv.innerHTML = `
                        <div class="flex justify-between">
                            <span class="text-gray-600">Xuất xứ:</span>
                            <span class="font-medium">${productData.origin || 'Không rõ'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Trọng lượng:</span>
                            <span class="font-medium">${productData.weight || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Hạn sử dụng:</span>
                            <span class="font-medium">${productData.expiry || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Bảo quản:</span>
                            <span class="font-medium">${productData.storage || 'Tủ lạnh'}</span>
                        </div>
                    `;
                    
                    // 6. Số lượng còn lại 
                    document.querySelector('.text-gray-600:last-of-type').textContent = `Còn lại: ${productData.stock || '0'} sản phẩm`;

                    // FIX LỖI THÔNG TIN CHI TIẾT: Cập nhật nội dung mô tả đầy đủ trong tab
                    if (descriptionContentDiv) {
                        // Thay thế \n thành <br> để HTML hiểu xuống dòng
                        const fullDescriptionHtml = (productData.description || 'Không có mô tả chi tiết.').replace(/\n/g, '<br>');
                        descriptionContentDiv.innerHTML = `
                            <div class="text-gray-700 leading-relaxed space-y-4">
                                ${fullDescriptionHtml}
                            </div>
                        `;
                    }

                } else {
                    console.error('Failed to load product details:', response.status);
                    document.getElementById('product-name-detail').textContent = 'Không tìm thấy sản phẩm';
                    document.getElementById('product-description').textContent = 'Xin lỗi, sản phẩm này hiện không khả dụng.';
                    if (reviewCountTab) reviewCountTab.textContent = 0;
                }
            } catch (error) {
                console.error('Error loading product details:', error);
                document.getElementById('product-name-detail').textContent = 'Lỗi kết nối';
                document.getElementById('product-description').textContent = 'Không thể kết nối đến máy chủ để tải thông tin sản phẩm.';
            }
        }
        
        // 1. Load Reviews (Đã thêm /api/)
        async function loadReviews() {
            const reviewList = document.getElementById('review-list');
            const reviewCount = document.getElementById('review-count');
            const reviewCountTab = document.getElementById('review-count-tab');
            reviewList.innerHTML = '<div class="text-center text-gray-500 py-10">Đang tải đánh giá...</div>';
            
            try {
                // FIX: Thêm /api/
                const response = await fetch(`${API_BASE_URL}/api/reviews?product_id=${productId}`);
                
                if (response.ok) {
                    const reviews = await response.json();
                    reviewList.innerHTML = '';
                    reviewCount.textContent = reviews.length;
                    reviewCountTab.textContent = reviews.length; // Cập nhật cả ở tab

                    if (reviews.length === 0) {
                        reviewList.innerHTML = '<div class="text-gray-500 text-center py-6 border rounded-lg">Chưa có đánh giá nào. Hãy là người đầu tiên!</div>';
                        return;
                    }
                    
                    reviews.forEach(r => {
                        const stars = '★'.repeat(r.rating) + '☆'.repeat(5-r.rating);
                        reviewList.innerHTML += `
                            <div class="border-b py-3 last:border-b-0">
                                <div class="flex items-center mb-1">
                                    <span class="font-semibold text-green-700 mr-2">${r.user_email || 'Khách hàng'}</span>
                                    <span class="text-yellow-500 text-lg">${stars}</span>
                                    <span class="ml-auto text-xs text-gray-400">${new Date(r.created_at || Date.now()).toLocaleDateString('vi-VN')}</span>
                                </div>
                                <div class="text-gray-700">${r.comment}</div>
                            </div>`;
                    });

                } else {
                    reviewList.innerHTML = '<div class="text-red-500 text-center py-6">Không thể tải đánh giá.</div>';
                }
            } catch (error) {
                console.error('Error loading reviews:', error);
                reviewList.innerHTML = '<div class="text-red-500 text-center py-6">Lỗi kết nối mạng.</div>';
            }
        }

        // 2. Submit Review (Đã thêm /api/)
        document.getElementById('review-form').onsubmit = async function(e) {
            e.preventDefault();
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            const reviewMessage = document.getElementById('review-message');
            reviewMessage.classList.remove('hidden', 'text-red-500', 'text-green-500');
            reviewMessage.textContent = 'Đang gửi...';

            if (!user) {
                reviewMessage.textContent = 'Bạn cần đăng nhập để đánh giá!';
                reviewMessage.classList.add('text-red-500');
                reviewMessage.classList.remove('hidden');
                return;
            }

            const rating = document.getElementById('review-rating').value;
            const comment = document.getElementById('review-comment').value;

            try {
                // FIX: Thêm /api/
                const response = await fetch(`${API_BASE_URL}/api/reviews`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product_id: productId,
                        user_email: user.email,
                        rating: parseInt(rating),
                        comment
                    })
                });
                
                const data = await response.json();

                if (response.ok) {
                    reviewMessage.textContent = 'Gửi đánh giá thành công!';
                    reviewMessage.classList.add('text-green-500');
                    document.getElementById('review-comment').value = '';
                    loadReviews(); // Tải lại danh sách đánh giá
                } else {
                    reviewMessage.textContent = data.error || 'Gửi đánh giá thất bại!';
                    reviewMessage.classList.add('text-red-500');
                }
            } catch (error) {
                console.error('Error submitting review:', error);
                reviewMessage.textContent = 'Lỗi kết nối mạng hoặc server!';
                reviewMessage.classList.add('text-red-500');
            }
            reviewMessage.classList.remove('hidden');
        };

        // 3. Load Product Journey (Đã thêm /api/)
        async function renderProductJourney() {
            const journeyTimeline = document.getElementById('journey-timeline');
            journeyTimeline.innerHTML = '<div class="text-center text-gray-500 py-10">Đang tải thông tin hành trình...</div>';

            try {
                // FIX: Thêm /api/
                const response = await fetch(`${API_BASE_URL}/api/products/${productId}/journey`); 
                
                if (response.ok) {
                    const journey = await response.json();
                    journeyTimeline.innerHTML = '';

                    if (journey.length === 0) {
                        journeyTimeline.innerHTML = '<div class="text-gray-500 text-center py-6 border rounded-lg">Không có thông tin hành trình.</div>';
                        return;
                    }
                    
                    // Sắp xếp theo ngày tăng dần
                    journey.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                    journey.forEach(step => {
                        journeyTimeline.innerHTML += `
                            <div class="timeline-item pb-6">
                                <div class="timeline-dot"></div>
                                <div class="text-sm text-green-600 font-bold">${new Date(step.timestamp).toLocaleDateString('vi-VN')} - ${new Date(step.timestamp).toLocaleTimeString('vi-VN').substring(0, 5)}</div>
                                <h4 class="font-semibold text-gray-800 text-lg">${step.stage}</h4>
                                <p class="text-gray-600">${step.details}</p>
                            </div>
                        `;
                    });
                } else {
                    journeyTimeline.innerHTML = '<div class="text-red-500 text-center py-6">Không thể tải hành trình sản phẩm.</div>';
                }
            } catch (error) {
                console.error('Error loading product journey:', error);
                journeyTimeline.innerHTML = '<div class="text-red-500 text-center py-6">Lỗi kết nối mạng.</div>';
            }
        }

        // 4. Load Recommended Products (ĐÃ FIX API và tham số)
        async function loadRecommendedProducts() {
            const container = document.getElementById('recommend-products');
            container.innerHTML = '<div class="col-span-4 text-center text-gray-500 py-10">Đang tải gợi ý...</div>';

            try {
                // FIX LỖI API: Gọi đúng endpoint /api/recommend-products
                // Truyền product_id để backend tìm sản phẩm cùng loại
                const response = await fetch(`${API_BASE_URL}/api/recommend-products?product_id=${productId}`); 
                
                if (response.ok) {
                    const data = await response.json();
                    container.innerHTML = '';
                    
                    if (!data || data.length === 0) {
                        container.innerHTML = '<div class="col-span-4 text-gray-500 text-center py-6">Không tìm thấy gợi ý sản phẩm.</div>';
                        return;
                    }
                    
                    data.forEach(p => {
                        container.innerHTML += `
                            <div class="card bg-white p-4 flex flex-col items-center text-center">
                                <img src="${p.image || 'https://via.placeholder.com/300x200/cccccc/ffffff?text=Product'}" alt="${p.name}" class="w-full h-40 object-cover rounded-lg mb-4">
                                <h3 class="font-bold text-lg mb-2 text-green-700">${p.name}</h3>
                                <div class="text-green-600 font-semibold mb-2">${formatCurrency(p.price)}</div>
                                <div class="text-gray-600 text-sm mb-2 line-clamp-2">${p.description}</div>
                                <a href="product-detail.html?id=${p.id}" class="btn-primary px-4 py-2 rounded-full font-semibold mt-auto bg-green-500 text-white hover:bg-green-600">Xem chi tiết</a>
                            </div>
                        `;
                    });
                } else {
                    container.innerHTML = `<div class="col-span-4 text-red-500 text-center py-6">Không thể tải gợi ý sản phẩm. (Status: ${response.status})</div>`;
                }
            } catch (error) {
                console.error('Error loading recommended products:', error);
                container.innerHTML = '<div class="col-span-4 text-red-500 text-center py-6">Lỗi kết nối mạng.</div>';
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            setupTabs(); // Thiết lập chức năng chuyển tab
            
            // 1. Tải chi tiết sản phẩm trước (để có dữ liệu productData)
            loadProductDetails(); 
            
            // 2. Tải các thành phần phụ thuộc
            loadReviews();
            // renderProductJourney() sẽ được gọi khi click vào tab Journey lần đầu, nhưng ta gọi nó ở đây để tải lần đầu
            renderProductJourney(); 
            loadRecommendedProducts();
            
            // Tải lại Journey khi click tab (để đảm bảo dữ liệu mới nhất nếu cần)
            document.querySelector('.tab-button[data-target="journey-content"]').addEventListener('click', renderProductJourney);
        });

        // --- Cart Mockup (Basic) ---
        function addToCart() {
            alert(`Đã thêm ${quantity} sản phẩm '${productData ? productData.name : 'sản phẩm'}' vào giỏ hàng! (Chức năng này cần API giỏ hàng thực tế)`);
            let currentCartCount = parseInt(document.getElementById('cart-count').textContent);
            document.getElementById('cart-count').textContent = currentCartCount + quantity;
        }

    </script>
</body>
</html>