<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Đang tải chi tiết sản phẩm...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .bg-gradient-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .card {
            border-radius: 1rem;
            box-shadow: 0 2px 12px rgba(16,185,129,0.08);
            transition: box-shadow 0.3s;
        }
        .card:hover {
            box-shadow: 0 8px 32px rgba(16,185,129,0.18);
        }
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(16,185,129,0.15);
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 8px 24px rgba(16,185,129,0.25);
        }
        /* Style cho Product Journey Timeline */
        .timeline-item {
            position: relative;
            padding-left: 3rem;
            border-left: 2px solid #34D399; /* green-400 */
        }
        .timeline-item:last-child {
            border-left: none;
            padding-bottom: 0;
        }
        .timeline-dot {
            position: absolute;
            left: -0.6rem;
            top: 0;
            width: 1.2rem;
            height: 1.2rem;
            background-color: #059669; /* green-700 */
            border-radius: 50%;
            border: 3px solid #E5E7EB; /* gray-200 */
        }
    </style>
</head>
<body class="bg-gray-50">
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between py-4">
                <a href="index.html" class="flex items-center space-x-2">
                    <div class="w-10 h-10 bg-gradient-green rounded-full flex items-center justify-center shadow-lg">
                        <i class="fas fa-leaf text-white text-xl"></i>
                    </div>
                    <span class="text-2xl font-extrabold text-green-600 tracking-wide">Green Fresh</span>
                </a>
                <nav class="hidden md:flex space-x-8">
                    <a href="index.html" class="text-gray-700 hover:text-green-600 font-semibold transition">Trang chủ</a>
                    <a href="products.html" class="text-green-600 font-semibold transition border-b-2 border-green-600 pb-1">Sản phẩm</a>
                    <a href="orders.html" class="text-gray-700 hover:text-green-600 font-semibold transition">Lịch sử đơn hàng</a>
                </nav>
                <div class="flex items-center space-x-4">
                    <button class="relative p-2 text-gray-700 hover:text-green-600">
                        <i class="fas fa-shopping-cart text-xl"></i>
                        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center" id="cart-count">0</span>
                    </button>
                    <a href="login.html" class="bg-gradient-green text-white px-4 py-2 rounded-full hover:scale-105 transition btn-primary" id="auth-button">
                        Đăng nhập
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="bg-white border-b">
        <div class="container mx-auto px-4 py-3">
            <nav class="flex items-center space-x-2 text-sm">
                <a href="index.html" class="text-gray-500 hover:text-green-600">Trang chủ</a>
                <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                <a href="products.html" class="text-gray-500 hover:text-green-600">Sản phẩm</a>
                <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                <span class="text-gray-800" id="breadcrumb-product-name">Đang tải...</span>
            </nav>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <div class="grid lg:grid-cols-2 gap-12" id="product-detail-container">
            <div>
                <div class="mb-4">
                    <img src="https://via.placeholder.com/500x400/9CA3AF/ffffff?text=Loading..." alt="Hình ảnh sản phẩm" 
                        class="w-full h-96 object-cover rounded-lg shadow-md" id="mainImage">
                </div>
                <div class="grid grid-cols-4 gap-2" id="thumbnail-gallery">
                    <img src="https://via.placeholder.com/100x100/9CA3AF/ffffff?text=Thumb1" alt="Thumbnail 1" 
                          class="w-full h-20 object-cover rounded cursor-pointer border-2 border-gray-300">
                    <img src="https://via.placeholder.com/100x100/9CA3AF/ffffff?text=Thumb2" alt="Thumbnail 2" 
                          class="w-full h-20 object-cover rounded cursor-pointer border-2 border-transparent hover:border-green-500">
                </div>
            </div>

            <div>
                <div class="mb-4" id="product-tags">
                    <span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm font-medium">Đang tải tag...</span>
                </div>
                
                <h1 class="text-3xl font-bold text-gray-800 mb-4" id="product-name-detail">Đang tải tên sản phẩm...</h1>
                
                <div class="flex items-center mb-4">
                    <div class="flex text-yellow-400 mr-2" id="product-rating">
                        </div>
                    <span class="text-gray-600">(<span id="average-rating">...</span>) • <span id="review-count">...</span> đánh giá</span>
                </div>

                <div class="mb-6">
                    <div class="flex items-center space-x-4">
                        <span class="text-3xl font-bold text-green-600" id="current-price">...</span>
                        <span class="text-xl text-gray-400 line-through" id="old-price">...</span>
                        <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-sm" id="discount-label"></span>
                    </div>
                    <p class="text-gray-600 mt-1" id="price-unit">Đơn vị: ...</p>
                </div>

                <div class="mb-6">
                    <h3 class="font-semibold mb-2">Mô tả sản phẩm:</h3>
                    <p class="text-gray-700 leading-relaxed" id="product-description">
                        Đang tải mô tả...
                    </p>
                </div>

                <div class="mb-6">
                    <h3 class="font-semibold mb-3">Thông tin sản phẩm:</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Xuất xứ:</span>
                            <span class="font-medium" id="product-origin">...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Trọng lượng:</span>
                            <span class="font-medium" id="product-weight">...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Hạn sử dụng:</span>
                            <span class="font-medium" id="product-expiry">...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Bảo quản:</span>
                            <span class="font-medium" id="product-storage">...</span>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="font-semibold mb-3">Số lượng:</h3>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center border border-gray-300 rounded">
                            <button class="px-3 py-2 hover:bg-gray-100" onclick="decreaseQuantity()">-</button>
                            <span class="px-4 py-2 border-l border-r border-gray-300" id="quantity">1</span>
                            <button class="px-3 py-2 hover:bg-gray-100" onclick="increaseQuantity()">+</button>
                        </div>
                        <span class="text-gray-600" id="product-stock">Còn lại: ... sản phẩm</span>
                    </div>
                </div>

                <div class="flex space-x-4 mb-6">
                    <button class="flex-1 bg-green-500 text-white py-3 px-6 rounded-lg hover:bg-green-600 transition font-semibold" onclick="addToCart()">
                        <i class="fas fa-shopping-cart mr-2"></i>
                        Thêm vào giỏ hàng
                    </button>
                    <button class="bg-orange-500 text-white py-3 px-6 rounded-lg hover:bg-orange-600 transition font-semibold">
                        Mua ngay
                    </button>
                    <button class="border border-gray-300 p-3 rounded-lg hover:bg-gray-100">
                        <i class="far fa-heart text-xl"></i>
                    </button>
                </div>

                <div class="border-t pt-6">
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <i class="fas fa-truck text-green-500 text-2xl mb-2"></i>
                            <p class="text-sm font-medium">Giao hàng nhanh</p>
                            <p class="text-xs text-gray-600">2-4 giờ</p>
                        </div>
                        <div>
                            <i class="fas fa-shield-alt text-blue-500 text-2xl mb-2"></i>
                            <p class="text-sm font-medium">Đảm bảo chất lượng</p>
                            <p class="text-xs text-gray-600">Hoàn tiền 100%</p>
                        </div>
                        <div>
                            <i class="fas fa-headset text-purple-500 text-2xl mb-2"></i>
                            <p class="text-sm font-medium">Hỗ trợ 24/7</p>
                            <p class="text-xs text-gray-600">Tư vấn miễn phí</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-16">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8">
                    <button class="tab-button py-4 px-1 border-b-2 border-green-500 font-medium text-green-600" data-target="detail-content">
                        Mô tả chi tiết
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700" data-target="review-content" id="tab-review">
                        Đánh giá
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700" data-target="journey-content">
                        Hành trình sản phẩm
                    </button>
                </nav>
            </div>
            
            <div class="py-8" id="detail-content">
                <div class="prose max-w-none" id="detailed-description-container">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Thông tin chi tiết về sản phẩm</h3>
                    <p class="mb-4">
                        Đang tải thông tin chi tiết...
                    </p>
                </div>
            </div>

            <div class="py-8 hidden" id="review-content">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Đánh giá & bình luận sản phẩm</h3>
                <form id="review-form" class="mb-6 bg-white p-6 rounded-lg shadow-md border-l-4 border-green-500">
                    <p class="font-medium mb-3">Gửi đánh giá của bạn (Cần đăng nhập)</p>
                    <div class="flex items-center mb-2">
                        <span class="mr-2 text-gray-700">Chọn đánh giá:</span>
                        <select id="review-rating" class="border border-gray-300 rounded px-3 py-1">
                            <option value="5">5 sao</option>
                            <option value="4">4 sao</option>
                            <option value="3">3 sao</option>
                            <option value="2">2 sao</option>
                            <option value="1">1 sao</option>
                        </select>
                    </div>
                    <textarea id="review-comment" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 mb-4 mt-2 focus:ring-green-500 focus:border-green-500" placeholder="Nhập bình luận..."></textarea>
                    <button type="submit" class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600 font-semibold transition">Gửi đánh giá</button>
                    <div id="review-message" class="mt-3 text-sm hidden"></div>
                </form>
                <div id="review-list">
                    <div class="text-center text-gray-500 py-10">Đang tải đánh giá...</div>
                </div>
            </div>

            <div class="py-8 hidden" id="journey-content">
                <h3 class="font-bold text-xl mb-6 text-green-700 flex items-center gap-2">
                    <i class="fas fa-route"></i> Hành trình sản phẩm
                </h3>
                <div id="journey-timeline" class="space-y-6">
                    <div class="text-center text-gray-500 py-10">Đang tải thông tin hành trình...</div>
                </div>
            </div>
            
        </div>

        <div class="mt-16">
            <h2 class="text-2xl font-bold text-green-700 mb-8 border-b pb-3 flex items-center gap-3">
                <i class="fas fa-robot"></i> Sản phẩm gợi ý cho bạn
            </h2>
            <div id="recommend-products" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
                <div class="col-span-4 text-center text-gray-500 py-10">Đang tải gợi ý...</div>
            </div>
        </div>

    </div>

    <footer class="bg-gray-800 text-white py-12 mt-16">
        <div class="container mx-auto px-4">
            <div class="text-center text-gray-400">
                <p>&copy; 2024 Green Fresh. Tất cả quyền được bảo lưu.</p>
            </div>
        </div>
    </footer>

    <script>
        const API_BASE_URL = 'https://exe-zjbe.onrender.com/api';
        
        // LẤY PRODUCT ID TỪ URL - KHÔNG GÁN CỨNG NỮA
        const urlParams = new URLSearchParams(window.location.search);
        // BỎ GÁN CỨNG: nếu không có ID, productId sẽ là null, và loadProductDetail() sẽ báo lỗi.
        const productId = urlParams.get('id'); 
        
        let quantity = 1;

        // Lưu trữ dữ liệu sản phẩm hiện tại để sử dụng trong addToCart()
        let currentProductData = null;

        // Helper function to format currency (VND)
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }
        
        // --- Quantity Controls ---
        function increaseQuantity() {
            quantity++;
            document.getElementById('quantity').textContent = quantity;
        }
        
        function decreaseQuantity() {
            if (quantity > 1) {
                quantity--;
                document.getElementById('quantity').textContent = quantity;
            }
        }
        
        // --- Tab Switching ---
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // ... (logic chuyển tab giữ nguyên)
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('border-green-500', 'text-green-600');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700');
                });
                document.querySelectorAll('[id$="-content"]').forEach(content => {
                    content.classList.add('hidden');
                });

                const targetId = button.getAttribute('data-target');
                button.classList.add('border-green-500', 'text-green-600');
                button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700');
                document.getElementById(targetId).classList.remove('hidden');
            });
        });

        // --- Authentication Check (Mockup) ---
        function checkAuth() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            const authButton = document.getElementById('auth-button');
            if (token && user) {
                authButton.textContent = user.email.split('@')[0]; // Hiển thị tên người dùng
                authButton.href = 'profile.html';
            } else {
                authButton.textContent = 'Đăng nhập';
                authButton.href = 'login.html';
            }
        }

        // --- Render Star Rating ---
        function renderStars(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5 ? 1 : 0;
            const emptyStars = 5 - fullStars - halfStar;
            
            let html = '';
            for (let i = 0; i < fullStars; i++) html += '<i class="fas fa-star"></i>';
            if (halfStar) html += '<i class="fas fa-star-half-alt"></i>';
            for (let i = 0; i < emptyStars; i++) html += '<i class="far fa-star"></i>';
            
            return html;
        }

        // =======================================================
        //                 HÀM TẢI CHI TIẾT SẢN PHẨM (FIX)
        // =======================================================
        async function loadProductDetail() {
            const container = document.getElementById('product-detail-container');
            const productNameDetail = document.getElementById('product-name-detail');

            if (!productId) {
                productNameDetail.textContent = 'Lỗi: Không tìm thấy ID sản phẩm trong URL.';
                container.innerHTML = '<div class="text-center text-red-500 py-20">Vui lòng kiểm tra lại liên kết sản phẩm.</div>';
                return;
            }

            productNameDetail.textContent = 'Đang tải...';
            document.getElementById('page-title').textContent = 'Đang tải...';
            
            try {
                // API endpoint của bạn là 'https://exe-zjbe.onrender.com/api'
                const response = await fetch(`${API_BASE_URL}/products/${productId}`);
                
                if (response.ok) {
                    const product = await response.json();
                    currentProductData = product; // Lưu dữ liệu sản phẩm

                    // 1. CẬP NHẬT THÔNG TIN TĨNH BỊ GÁN CỨNG TRONG HTML
                    
                    // Header và Breadcrumb
                    document.getElementById('page-title').textContent = `${product.name} - Green Fresh`;
                    document.getElementById('breadcrumb-product-name').textContent = product.name;
                    
                    // Khu vực thông tin chính
                    productNameDetail.textContent = product.name;
                    document.getElementById('mainImage').src = product.image || 'https://via.placeholder.com/500x400/10b981/ffffff?text=' + product.name.replace(/ /g, '+');
                    document.getElementById('product-description').textContent = product.description;

                    // Giá
                    const oldPrice = product.old_price || product.price * 1.2;
                    const discount = 1 - (product.price / oldPrice);
                    document.getElementById('current-price').textContent = formatCurrency(product.price);
                    document.getElementById('old-price').textContent = formatCurrency(oldPrice);
                    document.getElementById('discount-label').textContent = `Giảm ${Math.round(discount * 100)}%`;
                    document.getElementById('price-unit').textContent = `Giá đã bao gồm VAT / Đơn vị: ${product.unit || '500g'}`;

                    // Thông tin chi tiết
                    document.getElementById('product-origin').textContent = product.origin || 'Không rõ';
                    document.getElementById('product-weight').textContent = product.unit || 'N/A';
                    document.getElementById('product-expiry').textContent = product.expiry || 'N/A';
                    document.getElementById('product-storage').textContent = product.storage || 'N/A';
                    document.getElementById('product-stock').textContent = `Còn lại: ${product.stock || 0} sản phẩm`;
                    
                    // Tag (ví dụ: 'Hữu cơ')
                    const tagsHtml = (product.tags || []).map(tag => 
                        `<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">${tag}</span>`
                    ).join('');
                    document.getElementById('product-tags').innerHTML = tagsHtml || '';

                    // Mô tả chi tiết tab đầu tiên (ví dụ gán lại mô tả chi tiết từ API)
                    document.getElementById('detailed-description-container').innerHTML = `
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">Thông tin chi tiết về sản phẩm</h3>
                        <p class="mb-4">
                            ${product.detailed_description || product.description}
                        </p>
                        <h4 class="text-lg font-semibold mb-2 text-green-700">Giá trị dinh dưỡng:</h4>
                        <ul class="list-disc list-inside mb-4 space-y-1">
                            ${(product.nutritional_info || ['Đang cập nhật...']).map(info => `<li>${info}</li>`).join('')}
                        </ul>
                    `;


                    // 2. KHỞI CHẠY TẢI CÁC DỮ LIỆU PHỤ (Reviews, Journey, Recommendations)
                    loadReviews();
                    // renderProductJourney(); // Khởi chạy khi người dùng nhấn tab
                    loadRecommendedProducts();

                } else {
                    productNameDetail.textContent = 'Sản phẩm không tồn tại.';
                    container.innerHTML = '<div class="text-center text-red-500 py-20">Không tìm thấy thông tin sản phẩm này.</div>';
                }
            } catch (error) {
                console.error('Error loading product detail:', error);
                productNameDetail.textContent = 'Lỗi kết nối server.';
                container.innerHTML = '<div class="text-center text-red-500 py-20">Lỗi kết nối mạng hoặc server không phản hồi.</div>';
            }
        }

        // 1. Load Reviews
        async function loadReviews() {
            // ... (Logic load Reviews giữ nguyên, nhưng giờ đã có productId đúng)
            const reviewList = document.getElementById('review-list');
            reviewList.innerHTML = '<div class="text-center text-gray-500 py-10">Đang tải đánh giá...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/reviews?product_id=${productId}`);
                
                if (response.ok) {
                    const reviews = await response.json();
                    reviewList.innerHTML = '';
                    document.getElementById('review-count').textContent = reviews.length;

                    if (reviews.length === 0) {
                        reviewList.innerHTML = '<div class="text-gray-500 text-center py-6 border rounded-lg">Chưa có đánh giá nào. Hãy là người đầu tiên!</div>';
                        return;
                    }
                    
                    // Tính rating trung bình
                    const totalRating = reviews.reduce((sum, r) => sum + r.rating, 0);
                    const avgRating = (totalRating / reviews.length).toFixed(1);
                    document.getElementById('average-rating').textContent = avgRating;
                    document.getElementById('product-rating').innerHTML = renderStars(parseFloat(avgRating));

                    reviews.forEach(r => {
                        const stars = '★'.repeat(r.rating) + '☆'.repeat(5-r.rating);
                        reviewList.innerHTML += `
                            <div class="border-b py-3 last:border-b-0">
                                <div class="flex items-center mb-1">
                                    <span class="font-semibold text-green-700 mr-2">${r.user_email || 'Khách hàng'}</span>
                                    <span class="text-yellow-500 text-lg">${stars}</span>
                                    <span class="ml-auto text-xs text-gray-400">${new Date(r.created_at || Date.now()).toLocaleDateString('vi-VN')}</span>
                                </div>
                                <div class="text-gray-700">${r.comment}</div>
                            </div>`;
                    });

                } else {
                    reviewList.innerHTML = '<div class="text-red-500 text-center py-6">Không thể tải đánh giá.</div>';
                }
            } catch (error) {
                console.error('Error loading reviews:', error);
                reviewList.innerHTML = '<div class="text-red-500 text-center py-6">Lỗi kết nối mạng.</div>';
            }
        }

        // 2. Submit Review
        document.getElementById('review-form').onsubmit = async function(e) {
            e.preventDefault();
            // ... (Logic submit review giữ nguyên)
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            const token = localStorage.getItem('token');
            const reviewMessage = document.getElementById('review-message');
            reviewMessage.classList.remove('hidden', 'text-red-500', 'text-green-500');
            reviewMessage.textContent = 'Đang gửi...';

            if (!user || !token) {
                reviewMessage.textContent = 'Bạn cần đăng nhập để đánh giá!';
                reviewMessage.classList.add('text-red-500');
                reviewMessage.classList.remove('hidden');
                return;
            }

            const rating = document.getElementById('review-rating').value;
            const comment = document.getElementById('review-comment').value;

            try {
                const response = await fetch(`${API_BASE_URL}/reviews`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        user_email: user.email,
                        rating: parseInt(rating),
                        comment
                    })
                });
                
                const data = await response.json();

                if (response.ok) {
                    reviewMessage.textContent = 'Gửi đánh giá thành công!';
                    reviewMessage.classList.add('text-green-500');
                    document.getElementById('review-comment').value = '';
                    loadReviews(); // Tải lại danh sách đánh giá
                } else {
                    reviewMessage.textContent = data.message || 'Gửi đánh giá thất bại!';
                    reviewMessage.classList.add('text-red-500');
                }
            } catch (error) {
                console.error('Error submitting review:', error);
                reviewMessage.textContent = 'Lỗi kết nối mạng hoặc server!';
                reviewMessage.classList.add('text-red-500');
            }
            reviewMessage.classList.remove('hidden');
        };

        // 3. Load Product Journey
        async function renderProductJourney() {
            // ... (Logic render Product Journey giữ nguyên)
            const journeyTimeline = document.getElementById('journey-timeline');
            journeyTimeline.innerHTML = '<div class="text-center text-gray-500 py-10">Đang tải thông tin hành trình...</div>';

            try {
                // Endpoint giả định cho hành trình sản phẩm
                const response = await fetch(`${API_BASE_URL}/products/${productId}/journey`); 
                
                if (response.ok) {
                    const journey = await response.json();
                    journeyTimeline.innerHTML = '';

                    if (journey.length === 0) {
                        journeyTimeline.innerHTML = '<div class="text-gray-500 text-center py-6 border rounded-lg">Không có thông tin hành trình.</div>';
                        return;
                    }
                    
                    // Sắp xếp theo ngày tăng dần
                    journey.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                    journey.forEach(step => {
                        journeyTimeline.innerHTML += `
                            <div class="timeline-item pb-6">
                                <div class="timeline-dot"></div>
                                <div class="text-sm text-green-600 font-bold">${new Date(step.timestamp).toLocaleDateString('vi-VN')} - ${new Date(step.timestamp).toLocaleTimeString('vi-VN').substring(0, 5)}</div>
                                <h4 class="font-semibold text-gray-800 text-lg">${step.stage}</h4>
                                <p class="text-gray-600">${step.details}</p>
                            </div>
                        `;
                    });
                } else {
                    journeyTimeline.innerHTML = '<div class="text-red-500 text-center py-6">Không thể tải hành trình sản phẩm.</div>';
                }
            } catch (error) {
                console.error('Error loading product journey:', error);
                journeyTimeline.innerHTML = '<div class="text-red-500 text-center py-6">Lỗi kết nối mạng.</div>';
            }
        }

        // 4. Load Recommended Products
        async function loadRecommendedProducts() {
            // ... (Logic load Recommended Products giữ nguyên)
            const container = document.getElementById('recommend-products');
            container.innerHTML = '<div class="col-span-4 text-center text-gray-500 py-10">Đang tải gợi ý...</div>';

            try {
                // Sử dụng API backend cho gợi ý sản phẩm
                const response = await fetch(`${API_BASE_URL}/products?limit=4&exclude=${productId}`); 
                
                if (response.ok) {
                    const data = await response.json();
                    container.innerHTML = '';
                    
                    if (!data || data.length === 0) {
                        container.innerHTML = '<div class="col-span-4 text-gray-500 text-center py-6">Chưa có gợi ý sản phẩm.</div>';
                        return;
                    }
                    
                    data.forEach(p => {
                        container.innerHTML += `
                            <div class="card bg-white p-4 flex flex-col items-center text-center">
                                <img src="${p.image || 'https://via.placeholder.com/300x200/cccccc/ffffff?text=Product'}" alt="${p.name}" class="w-full h-40 object-cover rounded-lg mb-4">
                                <h3 class="font-bold text-lg mb-2 text-green-700">${p.name}</h3>
                                <div class="text-green-600 font-semibold mb-2">${formatCurrency(p.price)}</div>
                                <div class="text-gray-600 text-sm mb-2 line-clamp-2">${p.description}</div>
                                <a href="product-detail.html?id=${p._id}" class="btn-primary px-4 py-2 rounded-full font-semibold mt-auto">Xem chi tiết</a>
                            </div>
                        `;
                    });
                } else {
                    container.innerHTML = '<div class="col-span-4 text-red-500 text-center py-6">Không thể tải gợi ý sản phẩm.</div>';
                }
            } catch (error) {
                console.error('Error loading recommended products:', error);
                container.innerHTML = '<div class="col-span-4 text-red-500 text-center py-6">Lỗi kết nối mạng.</div>';
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadProductDetail(); // KHỞI ĐỘNG HÀM TẢI CHI TIẾT SẢN PHẨM

            // Gán lại sự kiện click cho tab Journey (đã sửa để chạy hàm khi click)
            document.querySelector('.tab-button[data-target="journey-content"]').addEventListener('click', renderProductJourney);
        });

        // --- Cart Mockup (Basic) ---
        function addToCart() {
            if (currentProductData) {
                alert(`Đã thêm ${quantity} sản phẩm '${currentProductData.name}' vào giỏ hàng! (Chức năng này cần API giỏ hàng thực tế)`);
                let currentCartCount = parseInt(document.getElementById('cart-count').textContent);
                document.getElementById('cart-count').textContent = currentCartCount + quantity;
            } else {
                alert('Không thể thêm vào giỏ hàng vì dữ liệu sản phẩm chưa được tải.');
            }
        }

    </script>
</body>
</html>