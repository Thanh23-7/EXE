<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh S√°ch S·∫£n Ph·∫©m - E-commerce S·∫°ch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* T√πy ch·ªânh m√†u s·∫Øc Tailwind (Green cho theme Organic) */
        .btn-primary {
            /* @apply bg-green-500 hover:bg-green-600 focus:ring-green-500; */
            background-color: #10B981; /* green-500 */
            transition: background-color 0.15s;
        }
        .btn-primary:hover {
            background-color: #059669; /* green-600 */
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        /* Style cho Filter Box */
        .filter-box {
            /* @apply bg-white p-6 rounded-lg shadow-lg mb-6 border border-gray-100; */
            background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); margin-bottom: 1.5rem; border: 1px solid #f3f4f6;
        }
        .filter-title {
            /* @apply text-xl font-bold mb-4 border-b pb-2 text-green-700; */
            font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; border-bottom: 1px solid; padding-bottom: 0.5rem; color: #047857;
        }
    </style>
</head>
<body class="bg-gray-50">

    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-green-600">Organic Shop üåæ</h1>
            <nav class="flex items-center space-x-4">
                <div class="relative">
                    <a href="cart.html" class="text-gray-700 hover:text-green-600 transition">
                        <i class="fas fa-shopping-cart text-xl"></i>
                        <span id="cart-count" class="absolute -top-1 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                    </a>
                </div>
                <div id="user-info" class="flex items-center space-x-3">
                    </div>
            </nav>
        </div>
    </header>

    <div class="container mx-auto px-4 py-3 text-sm text-gray-500">
        <a href="index.html" class="hover:text-green-600">Trang ch·ªß</a> / <span class="font-semibold text-gray-700">Danh s√°ch S·∫£n ph·∫©m</span>
    </div>
    
    <main class="container mx-auto px-4 py-8">
        <h2 class="text-3xl font-extrabold text-gray-800 mb-6">Th·ª±c Ph·∫©m H·ªØu C∆° & S·∫°ch</h2>

        <div class="flex flex-col lg:flex-row gap-8">
            <aside class="w-full lg:w-1/4">

                <div class="filter-box">
                    <h3 class="filter-title">T√¨m ki·∫øm</h3>
                    <input type="text" id="search-input" placeholder="T√¨m ki·∫øm t√™n s·∫£n ph·∫©m..." class="w-full border border-gray-300 p-2 rounded focus:ring-green-500 focus:border-green-500">
                </div>

                <div class="filter-box">
                    <h3 class="filter-title">Danh m·ª•c</h3>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" data-category="Rau c·ªß qu·∫£" class="category-filter form-checkbox h-5 w-5 text-green-600 rounded" />
                            <span class="ml-2 text-gray-700">Rau c·ªß qu·∫£</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" data-category="Th·ªãt s·∫°ch" class="category-filter form-checkbox h-5 w-5 text-green-600 rounded" />
                            <span class="ml-2 text-gray-700">Th·ªãt s·∫°ch</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" data-category="H·∫£i s·∫£n" class="category-filter form-checkbox h-5 w-5 text-green-600 rounded" />
                            <span class="ml-2 text-gray-700">H·∫£i s·∫£n</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" data-category="Tr√°i c√¢y" class="category-filter form-checkbox h-5 w-5 text-green-600 rounded" />
                            <span class="ml-2 text-gray-700">Tr√°i c√¢y</span>
                        </label>
                    </div>
                </div>

                <div class="filter-box">
                    <h3 class="filter-title">Kho·∫£ng gi√° (VNƒê)</h3>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="price_filter" value="0-50000" class="price-filter form-radio h-4 w-4 text-green-600" />
                            <span class="ml-2 text-gray-700">D∆∞·ªõi 50,000</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="price_filter" value="50000-100000" class="price-filter form-radio h-4 w-4 text-green-600" />
                            <span class="ml-2 text-gray-700">50,000 - 100,000</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="price_filter" value="100000-200000" class="price-filter form-radio h-4 w-4 text-green-600" />
                            <span class="ml-2 text-gray-700">100,000 - 200,000</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="price_filter" value="200000-max" class="price-filter form-radio h-4 w-4 text-green-600" />
                            <span class="ml-2 text-gray-700">Tr√™n 200,000</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="price_filter" value="" checked class="price-filter form-radio h-4 w-4 text-green-600" />
                            <span class="ml-2 text-gray-700 font-semibold">T·∫•t c·∫£</span>
                        </label>
                    </div>
                </div>

            </aside>

            <section class="w-full lg:w-3/4">
                <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-lg shadow-sm">
                    <p id="product-count-display" class="text-gray-600 font-medium">ƒêang t·∫£i...</p>
                    <div class="flex items-center space-x-3">
                        <label for="sort-select" class="text-gray-700">S·∫Øp x·∫øp theo:</label>
                        <select id="sort-select" class="border border-gray-300 p-2 rounded focus:ring-green-500 focus:border-green-500">
                            <option value="default">M·∫∑c ƒë·ªãnh</option>
                            <option value="price-asc">Gi√°: Th·∫•p ƒë·∫øn Cao</option>
                            <option value="price-desc">Gi√°: Cao ƒë·∫øn Th·∫•p</option>
                            <option value="newest-desc">M·ªõi nh·∫•t</option>
                            <option value="reviews-desc">B√°n ch·∫°y nh·∫•t</option>
                        </select>
                    </div>
                </div>

                <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="col-span-3 text-center py-10 text-xl text-green-600">
                        <i class="fas fa-spinner fa-spin mr-2"></i> ƒêang t·∫£i s·∫£n ph·∫©m...
                    </div>
                </div>

                <div class="flex justify-center items-center mt-10" id="pagination-container">
                    </div>
            </section>
        </div>
    </main>

    <div id="toast"></div>

    <footer class="bg-gray-800 text-white mt-12 py-8">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2024 Organic Shop. B·∫£o m·∫≠t & ƒêi·ªÅu kho·∫£n.</p>
        </div>
    </footer>

    <script>
        // --- KHAI B√ÅO C·∫§U H√åNH API ---
        const API_BASE_URL = 'https://exe-zjbe.onrender.com/api';
        const API_PRODUCTS_URL = `${API_BASE_URL}/products`; 
    
        // --- C·∫§U H√åNH PH√ÇN TRANG & TR·∫†NG TH√ÅI ---
        const productsPerPage = 9; // S·ªë s·∫£n ph·∫©m m·ªói trang (s·∫Ω g·ª≠i l√™n API)
        let currentPage = 1;
        
        // --- H√ÄM T·∫¢I D·ªÆ LI·ªÜU T·ª™ API (ƒê√É S·ª¨A) ---
        /**
         * T·∫£i s·∫£n ph·∫©m t·ª´ API, c√≥ √°p d·ª•ng l·ªçc, s·∫Øp x·∫øp v√† ph√¢n trang.
         * @param {boolean} updateUrlFlag - C√≥ c·∫≠p nh·∫≠t URL c·ªßa tr√¨nh duy·ªát kh√¥ng.
         */
        async function loadProductsFromAPI(updateUrlFlag = true) {
            const grid = document.getElementById('products-grid');
            const countDisplay = document.getElementById('product-count-display');
            const paginationContainer = document.getElementById('pagination-container');
            
            // ·∫®n n·ªôi dung c≈© v√† hi·ªÉn th·ªã tr·∫°ng th√°i t·∫£i
            if (grid) grid.innerHTML = '<div class="col-span-3 text-center py-10 text-xl text-green-600"><i class="fas fa-spinner fa-spin mr-2"></i> ƒêang t·∫£i s·∫£n ph·∫©m...</div>';
            if (countDisplay) countDisplay.textContent = 'ƒêang t·∫£i...';
            if (paginationContainer) paginationContainer.innerHTML = '';
            
            // 1. X√¢y d·ª±ng tham s·ªë truy v·∫•n (Queries)
            const params = new URLSearchParams();
            
            // Ph√¢n trang
            params.set('page', currentPage);
            params.set('limit', productsPerPage);
    
            // 2. L·∫•y tham s·ªë l·ªçc t·ª´ giao di·ªán (UI)
            const selectedCategories = Array.from(document.querySelectorAll('.category-filter:checked'))
                                             .map(input => input.getAttribute('data-category'));
            if (selectedCategories.length > 0) {
                // Backend c·∫ßn h·ªó tr·ª£ l·ªçc theo m·∫£ng category (chuy·ªÉn th√†nh chu·ªói)
                params.set('category', selectedCategories.join(','));
            }
    
            const selectedPrice = document.querySelector('.price-filter:checked');
            if (selectedPrice && selectedPrice.value) {
                const [min, max] = selectedPrice.value.split('-');
                params.set('minPrice', min);
                if (max !== 'max') params.set('maxPrice', max);
            }
    
            const sortValue = document.getElementById('sort-select').value;
            if (sortValue !== 'default') {
                const [field, direction] = sortValue.split('-');
                params.set('sortField', field); 
                params.set('sortDirection', direction); 
            }
    
            const searchTerm = document.getElementById('search-input').value;
            if (searchTerm) {
                params.set('search', searchTerm);
            }
    
            // 3. C·∫≠p nh·∫≠t URL tr√¨nh duy·ªát
            if (updateUrlFlag) {
                const newUrl = `${window.location.pathname}?${params.toString()}`;
                history.pushState(null, '', newUrl); 
            }
    
            // 4. G·ªçi API
            try {
                const response = await fetch(`${API_PRODUCTS_URL}?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // === LOGIC X·ª¨ L√ù ƒê·ªäNH D·∫†NG API (ƒê√É S·ª¨A T·∫†I ƒê√ÇY) ===
                let products = [];
                let totalProducts = 0;

                if (Array.isArray(data)) {
                    // Tr∆∞·ªùng h·ª£p Backend tr·∫£ v·ªÅ M·∫¢NG tr·ª±c ti·∫øp (nh∆∞ hi·ªán t·∫°i tr√™n Render)
                    products = data;
                    // ƒê·∫∑t totalProducts = s·ªë l∆∞·ª£ng s·∫£n ph·∫©m tr·∫£ v·ªÅ (t·ªëi ƒëa 9)
                    // L∆∞u √Ω: Ph√¢n trang s·∫Ω kh√¥ng ho·∫°t ƒë·ªông ƒë√∫ng cho ƒë·∫øn khi s·ª≠a Backend
                    totalProducts = data.length; 
                } else if (data && Array.isArray(data.products)) {
                    // Tr∆∞·ªùng h·ª£p Backend tr·∫£ v·ªÅ ƒê·ªêI T∆Ø·ª¢NG PH√ÇN TRANG (ƒë√∫ng format mong mu·ªën)
                    products = data.products;
                    totalProducts = data.totalCount || data.products.length; 
                }
                // ====================================================
    
                renderProducts(products, totalProducts); 
    
            } catch (error) {
                console.error("L·ªói API:", error);
                if (grid) grid.innerHTML = '<div class="col-span-3 text-center py-10 text-xl text-red-600">‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi Backend ho·∫∑c t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra console log.</div>';
                if (countDisplay) countDisplay.textContent = 'L·ªói t·∫£i d·ªØ li·ªáu';
            }
        }
    
    
        // --- H√ÄM KH·ªûI T·∫†O T·ª™ URL (GI·ªÆ NGUY√äN) ---
        function loadStateFromUrl() {
            const params = new URLSearchParams(window.location.search);
            
            // 1. L·∫•y trang hi·ªán t·∫°i
            const page = parseInt(params.get('page')) || 1;
            currentPage = page;
    
            // 2. √Åp d·ª•ng Danh m·ª•c
            const categoryParam = params.get('category');
            if (categoryParam) {
                const categories = categoryParam.split(',');
                document.querySelectorAll('.category-filter').forEach(input => {
                    if (categories.includes(input.getAttribute('data-category'))) {
                        input.checked = true;
                    }
                });
            }
    
            // 3. √Åp d·ª•ng Kho·∫£ng gi√°
            const minPrice = params.get('minPrice');
            const maxPrice = params.get('maxPrice');
            let priceValue = '';
            
            if (minPrice && maxPrice) {
                priceValue = `${minPrice}-${maxPrice}`;
            } else if (minPrice && !maxPrice) {
                priceValue = `${minPrice}-max`;
            }
            
            if (priceValue) {
                const priceInput = document.querySelector(`.price-filter[value="${priceValue}"]`);
                if (priceInput) {
                    priceInput.checked = true;
                }
            } else {
                // ƒê·∫£m b·∫£o n√∫t "T·∫•t c·∫£" ƒë∆∞·ª£c ch·ªçn n·∫øu kh√¥ng c√≥ b·ªô l·ªçc gi√° n√†o ƒë∆∞·ª£c √°p d·ª•ng
                const defaultPrice = document.querySelector('.price-filter[value=""]');
                if (defaultPrice) defaultPrice.checked = true;
            }
            
            // 4. √Åp d·ª•ng S·∫Øp x·∫øp
            const sortField = params.get('sortField');
            const sortDirection = params.get('sortDirection');
            if (sortField && sortDirection) {
                document.getElementById('sort-select').value = `${sortField}-${sortDirection}`;
            }
    
            // 5. √Åp d·ª•ng T√¨m ki·∫øm
            const searchParam = params.get('search');
            if (searchParam) {
                document.getElementById('search-input').value = searchParam;
            }
    
            // Sau khi ƒë·∫∑t c√°c gi√° tr·ªã ƒë·∫ßu v√†o, g·ªçi API ƒë·ªÉ t·∫£i d·ªØ li·ªáu ban ƒë·∫ßu
            loadProductsFromAPI(false); // Tham s·ªë false b√°o hi·ªáu kh√¥ng c·∫ßn update URL (v√¨ n√≥ ƒë√£ ƒë∆∞·ª£c t·∫£i t·ª´ URL)
        }
    
        // --- C√ÅC H√ÄM PH·ª§ TR·ª¢ (GI·ªÆ NGUY√äN) ---
    
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.opacity = 1;
            setTimeout(() => { toast.style.opacity = 0; }, 2000);
        }
        
        /**
         * H√†m th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng (kh√¥ng thay ƒë·ªïi)
         */
        window.addToCart = function(productId, productName, productPrice, productImage) {
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const productIndex = cart.findIndex(item => item.id === productId);
    
            if (productIndex > -1) {
                cart[productIndex].quantity = (cart[productIndex].quantity || 1) + 1;
            } else {
                // Ensure productPrice is a number before storing
                const price = parseFloat(productPrice);
                const newItem = { id: productId, name: productName, price: price, image: productImage, quantity: 1 };
                cart.push(newItem);
            }
    
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            showToast(`ƒê√£ th√™m 1 x "${productName}" v√†o gi·ªè h√†ng!`);
        }
    
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const cartCount = document.getElementById('cart-count');
            if (cartCount) cartCount.textContent = cart.reduce((total, item) => total + item.quantity, 0); 
        }
    
        function renderProducts(products, totalProducts) {
            const grid = document.getElementById('products-grid');
            const countDisplay = document.getElementById('product-count-display');
            
            if (!grid) return;
    
            grid.innerHTML = '';
            
            if (products.length === 0) {
                grid.innerHTML = '<p class="col-span-3 text-center text-gray-500 py-10">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o kh·ªõp v·ªõi b·ªô l·ªçc.</p>';
                countDisplay.textContent = `Hi·ªÉn th·ªã 0 c·ªßa ${totalProducts} s·∫£n ph·∫©m`;
                renderPagination(totalProducts); 
                return;
            }
            
            const displayStart = (currentPage - 1) * productsPerPage + 1;
            const displayEnd = displayStart + products.length - 1;
            
            // Ch√∫ √Ω: totalProducts ·ªü ƒë√¢y c√≥ th·ªÉ ch·ªâ l√† s·ªë l∆∞·ª£ng s·∫£n ph·∫©m tr√™n trang
            // n·∫øu Backend ch∆∞a ƒë∆∞·ª£c s·ª≠a ƒë√∫ng.
            // ƒêi·ªÅu ch·ªânh hi·ªÉn th·ªã ƒë·ªÉ tr√°nh b·ªã sai n·∫øu totalProducts = 0
            const actualTotal = totalProducts > 0 ? totalProducts : displayEnd; 
            
            countDisplay.textContent = `Hi·ªÉn th·ªã ${displayStart}-${displayEnd} c·ªßa ${actualTotal} s·∫£n ph·∫©m`;
    
    
            products.forEach((product) => {
                const stars = Array(5).fill(0).map((_, i) => 
                    `<i class="fas fa-star ${product.rating > i ? 'text-yellow-400' : 'text-gray-300'}"></i>`
                ).join('');
                
                const finalPrice = product.price || 0;
                // const finalRating = product.rating || 0; // rating kh√¥ng d√πng cho hi·ªÉn th·ªã

                grid.innerHTML += `
                    <div class="bg-white card overflow-hidden">
                        <div class="relative">
                            <img src="${product.image || 'placeholder.jpg'}" alt="${product.name}" class="w-full h-48 object-cover">
                            <span class="absolute top-2 left-2 bg-green-500 text-white px-2 py-1 rounded text-sm">${product.isOrganic ? 'H·ªØu c∆°' : 'Gi·∫£m 10%'}</span>
                            <button class="absolute top-2 right-2 w-8 h-8 bg-white rounded-full flex items-center justify-center hover:bg-gray-100">
                                <i class="far fa-heart text-gray-600"></i>
                            </button>
                        </div>
                        <div class="p-4">
                            <h3 class="font-semibold text-lg mb-2">${product.name}</h3>
                            <p class="text-gray-600 text-sm mb-3">${product.description || ''}</p>
                            <div class="flex items-center mb-2">
                                <div class="flex text-sm">${stars}</div>
                                <span class="text-gray-500 text-sm ml-2">(${product.reviews || 0})</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <span class="text-green-600 font-bold text-lg">${finalPrice.toLocaleString('vi-VN')}ƒë</span>
                                </div>
                                <button class="btn-primary text-white px-3 py-1 rounded transition add-to-cart-btn" 
                                    data-id="${product.id}" 
                                    data-name="${product.name}" 
                                    data-price="${finalPrice}" 
                                    data-image="${product.image || 'placeholder.jpg'}">
                                    <i class="fas fa-plus"></i> Mua h√†ng
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            renderPagination(totalProducts);
            // G·∫Øn s·ª± ki·ªán sau khi render xong
            attachAddToCartListeners(); 
        }

        /**
         * G·∫Øn s·ª± ki·ªán click cho c√°c n√∫t Mua h√†ng
         */
        function attachAddToCartListeners() {
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                // Lo·∫°i b·ªè l·∫Øng nghe c≈© n·∫øu c√≥
                button.removeEventListener('click', handleAddToCartClick); 
                // G·∫Øn l·∫Øng nghe m·ªõi
                button.addEventListener('click', handleAddToCartClick);
            });
        }
        
        /**
         * H√†m x·ª≠ l√Ω khi nh·∫•n n√∫t Mua h√†ng, l·∫•y data t·ª´ data-* attributes
         */
        function handleAddToCartClick() {
            const button = this; // 'this' l√† n√∫t button
            const id = parseInt(button.getAttribute('data-id'));
            const name = button.getAttribute('data-name');
            const price = parseFloat(button.getAttribute('data-price'));
            const image = button.getAttribute('data-image');
            
            window.addToCart(id, name, price, image);
        }

        function renderPagination(totalProducts) {
            const paginationContainer = document.getElementById('pagination-container');
            const totalPages = Math.ceil(totalProducts / productsPerPage);
            
            paginationContainer.innerHTML = '';
    
            if (totalPages <= 1) return;
    
            let paginationHTML = '';
            
            // N√∫t Previous
            paginationHTML += `
                <button class="px-4 py-2 mx-1 border rounded-lg transition ${currentPage === 1 ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white hover:bg-green-100 text-green-600'}" 
                    onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left text-xs"></i>
                </button>
            `;
    
            // C√°c n√∫t s·ªë trang
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            
            if (endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
    
    
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="px-4 py-2 mx-1 border rounded-lg font-semibold transition ${i === currentPage ? 'bg-green-500 text-white hover:bg-green-600' : 'bg-white hover:bg-gray-100 text-gray-700'}" 
                        onclick="changePage(${i})">
                        ${i}
                    </button>
                `;
            }
    
            // N√∫t Next
            paginationHTML += `
                <button class="px-4 py-2 mx-1 border rounded-lg transition ${currentPage === totalPages ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white hover:bg-green-100 text-green-600'}" 
                    onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right text-xs"></i>
                </button>
            `;
    
            paginationContainer.innerHTML = paginationHTML;
        }
    
        /**
         * Thay ƒë·ªïi trang hi·ªán t·∫°i v√† g·ªçi API ƒë·ªÉ t·∫£i l·∫°i s·∫£n ph·∫©m
         */
        window.changePage = function(page) {
            currentPage = page;
            loadProductsFromAPI(true); 
            
            document.getElementById('products-grid').scrollIntoView({ behavior: 'smooth' });
        }
    
        /**
         * √Åp d·ª•ng t·∫•t c·∫£ c√°c b·ªô l·ªçc, s·∫Øp x·∫øp.
         */
        function applyFilters(resetPage = true) {
            if (resetPage) {
                currentPage = 1;
            }
            loadProductsFromAPI(true); 
        }
    
    
        // --- G·∫ÆN S·ª∞ KI·ªÜN KHI TRANG LOAD (GI·ªÆ NGUY√äN) ---
    
        document.addEventListener('DOMContentLoaded', function() {
            // 1. Logic tr·∫°ng th√°i ƒëƒÉng nh·∫≠p (gi·ªØ nguy√™n)
            const userInfo = document.getElementById('user-info');
            let user = localStorage.getItem('user');
            if (user) {
                user = JSON.parse(user);
                userInfo.innerHTML = `
                    <span class="font-semibold text-green-600">${user.email}</span>
                    <button id="logoutBtn" class="bg-gray-200 text-gray-700 px-3 py-2 rounded-full hover:bg-gray-300 transition">ƒêƒÉng xu·∫•t</button>
                `;
                document.getElementById('logoutBtn').onclick = function() {
                    localStorage.removeItem('user');
                    // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß ho·∫∑c trang ƒëƒÉng nh·∫≠p
                    window.location.href = 'index.html'; 
                };
            } else {
                userInfo.innerHTML = `
                    <a href="login.html" class="bg-green-500 text-white px-4 py-2 rounded-full hover:bg-green-600 transition flex items-center justify-center">ƒêƒÉng nh·∫≠p</a>
                    <a href="register.html" class="bg-orange-500 text-white px-4 py-2 rounded-full hover:bg-orange-600 transition flex items-center justify-center">ƒêƒÉng k√Ω</a>
                `;
            }
    
            // 2. C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng gi·ªè h√†ng
            updateCartCount();
    
            // 3. Kh·ªüi t·∫°o tr·∫°ng th√°i ban ƒë·∫ßu t·ª´ URL v√† t·∫£i s·∫£n ph·∫©m
            loadStateFromUrl(); // G·ªçi h√†m n√†y s·∫Ω k√≠ch ho·∫°t loadProductsFromAPI
    
            // 4. G·∫Øn s·ª± ki·ªán cho c√°c b·ªô l·ªçc (ch·ªâ g·ªçi applyFilters)
            document.querySelectorAll('.category-filter, .price-filter').forEach(input => {
                input.addEventListener('change', () => applyFilters(true));
            });
    
            // G·∫Øn s·ª± ki·ªán cho S·∫Øp x·∫øp
            document.getElementById('sort-select').addEventListener('change', () => applyFilters(true));
            
            // G·∫Øn s·ª± ki·ªán cho T√¨m ki·∫øm (c√≥ Debounce)
            let searchTimer;
            document.getElementById('search-input').addEventListener('input', () => {
                clearTimeout(searchTimer);
                searchTimer = setTimeout(() => {
                    applyFilters(true);
                }, 300); // ƒê·ª£i 300ms sau khi ng∆∞·ªùi d√πng ng·ª´ng g√µ
            });
            
            // X·ª≠ l√Ω n√∫t back/forward c·ªßa tr√¨nh duy·ªát (Popstate)
            window.addEventListener('popstate', function() {
                loadStateFromUrl();
            });
        });
    </script>
</body>
</html>