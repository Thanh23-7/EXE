<script>
    // --- DỮ LIỆU SẢN PHẨM GIẢ ĐỊNH (MOCK DATA) ---
    const allProducts = [
        { id: 1, name: 'Thịt gà ta', price: 90000, category: 'Thịt sạch', description: 'Gà ta thả vườn, chắc thịt', image: 'https://i.imgur.com/gK5pYJ6.jpeg', rating: 4.5, reviews: 24, isOrganic: true },
        { id: 2, name: 'Tôm sú biển', price: 180000, category: 'Hải sản', description: 'Tôm sú tươi sống, ngọt thịt', image: 'https://i.imgur.com/vHqB3qB.jpeg', rating: 4.8, reviews: 35, isOrganic: false },
        { id: 3, name: 'Hàu sữa Pháp', price: 60000, category: 'Hải sản', description: 'Hàu sữa tươi, béo ngậy', image: 'https://i.imgur.com/sSgVbJm.jpeg', rating: 4.2, reviews: 18, isOrganic: false },
        { id: 4, name: 'Rau cải xanh hữu cơ', price: 25000, category: 'Rau củ quả', description: 'Tươi ngon, không hóa chất', image: 'https://i.imgur.com/w4p7r8q.jpeg', rating: 5.0, reviews: 45, isOrganic: true },
        { id: 5, name: 'Cà chua cherry Đà Lạt', price: 45000, category: 'Rau củ quả', description: 'Ngọt tự nhiên, giàu vitamin', image: 'https://i.imgur.com/YJgqDkU.jpeg', rating: 4.7, reviews: 60, isOrganic: true },
        { id: 6, name: 'Táo Fuji Nhật Bản', price: 120000, category: 'Trái cây', description: 'Giòn ngọt, chất lượng cao', image: 'https://i.imgur.com/hO5qW7O.jpeg', rating: 4.9, reviews: 78, isOrganic: false },
        { id: 7, name: 'Gạo hữu cơ ST25', price: 85000, category: 'Rau củ quả', description: 'Gạo thơm ngon, dinh dưỡng', image: 'https://i.imgur.com/rM1q5gP.jpeg', rating: 4.6, reviews: 50, isOrganic: true },
        { id: 8, name: 'Bò Úc tươi', price: 220000, category: 'Thịt sạch', description: 'Thịt bò nhập khẩu, mềm', image: 'https://i.imgur.com/M6Lg4gA.jpeg', rating: 4.4, reviews: 30, isOrganic: false },
        { id: 9, name: 'Sữa chua dâu', price: 15000, category: 'Khác', description: 'Sữa chua tự nhiên, vị dâu', image: 'https://i.imgur.com/hO5qW7O.jpeg', rating: 4.3, reviews: 22, isOrganic: true },
        // Thêm nhiều sản phẩm hơn để thấy rõ phân trang
        { id: 10, name: 'Bơ sáp Đắk Lắk', price: 70000, category: 'Trái cây', description: 'Bơ dẻo thơm ngon', image: 'https://i.imgur.com/rM1q5gP.jpeg', rating: 4.5, reviews: 20, isOrganic: true },
        { id: 11, name: 'Cá hồi tươi', price: 350000, category: 'Hải sản', description: 'Cá hồi Na Uy phi lê', image: 'https://i.imgur.com/w4p7r8q.jpeg', rating: 4.9, reviews: 90, isOrganic: false },
        { id: 12, name: 'Thịt heo sạch', price: 110000, category: 'Thịt sạch', description: 'Heo nuôi theo quy trình sạch', image: 'https://i.imgur.com/YJgqDkU.jpeg', rating: 4.6, reviews: 40, isOrganic: true },
        { id: 13, name: 'Bắp cải tí hon', price: 30000, category: 'Rau củ quả', description: 'Bắp cải Brussels mini', image: 'https://i.imgur.com/M6Lg4gA.jpeg', rating: 4.1, reviews: 15, isOrganic: true },
        { id: 14, name: 'Dâu tây Đà Lạt', price: 150000, category: 'Trái cây', description: 'Dâu tây đỏ mọng', image: 'https://i.imgur.com/hO5qW7O.jpeg', rating: 4.8, reviews: 55, isOrganic: false },
        { id: 15, name: 'Tôm hùm Canada', price: 800000, category: 'Hải sản', description: 'Tôm hùm nhập khẩu', image: 'https://i.imgur.com/vHqB3qB.jpeg', rating: 5.0, reviews: 10, isOrganic: false },
    ].filter(p => p.category !== 'Khác'); // Loại bỏ sản phẩm category 'Khác' để khớp với bộ lọc

    // --- CẤU HÌNH PHÂN TRANG & TRẠNG THÁI ---
    const productsPerPage = 9; // Số sản phẩm mỗi trang
    let currentPage = 1;
    let currentFilteredProducts = [];

    // --- HÀM CẬP NHẬT URL (QUAN TRỌNG) ---
    function updateUrl() {
        const params = new URLSearchParams();
        
        // 1. Trang hiện tại
        params.set('page', currentPage);

        // 2. Danh mục
        const selectedCategories = Array.from(document.querySelectorAll('.category-filter:checked'))
                                     .map(input => input.getAttribute('data-category'));
        if (selectedCategories.length > 0) {
            params.set('category', selectedCategories.join(','));
        }

        // 3. Khoảng giá
        const selectedPrice = document.querySelector('.price-filter:checked');
        if (selectedPrice) {
            params.set('price', selectedPrice.value);
        }
        
        // 4. Sắp xếp
        const sortValue = document.getElementById('sort-select').value;
        if (sortValue !== 'default') {
            params.set('sort', sortValue);
        }

        // 5. Tìm kiếm
        const searchTerm = document.getElementById('search-input').value;
        if (searchTerm) {
            params.set('search', searchTerm);
        }

        const newUrl = `${window.location.pathname}?${params.toString()}`;
        history.pushState(null, '', newUrl); // Cập nhật URL mà không cần tải lại trang
    }

    // --- HÀM KHỞI TẠO TỪ URL (QUAN TRỌNG) ---
    function loadStateFromUrl() {
        const params = new URLSearchParams(window.location.search);
        
        // 1. Lấy trang hiện tại
        const page = parseInt(params.get('page')) || 1;
        currentPage = page;

        // 2. Áp dụng Danh mục
        const categoryParam = params.get('category');
        if (categoryParam) {
            const categories = categoryParam.split(',');
            document.querySelectorAll('.category-filter').forEach(input => {
                if (categories.includes(input.getAttribute('data-category'))) {
                    input.checked = true;
                }
            });
        }

        // 3. Áp dụng Khoảng giá
        const priceParam = params.get('price');
        if (priceParam) {
            document.querySelector(`.price-filter[value="${priceParam}"]`).checked = true;
        }
        
        // 4. Áp dụng Sắp xếp
        const sortParam = params.get('sort');
        if (sortParam) {
            document.getElementById('sort-select').value = sortParam;
        }

        // 5. Áp dụng Tìm kiếm
        const searchParam = params.get('search');
        if (searchParam) {
            document.getElementById('search-input').value = searchParam;
        }

        // Sau khi đặt các giá trị đầu vào (input values), gọi applyFilters
        // để thực hiện việc lọc/sắp xếp ban đầu.
        applyFilters(false); // Tham số false báo hiệu không cần update URL nữa
    }

    // --- CÁC HÀM KHÁC (ĐÃ CẬP NHẬT) ---

    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.style.opacity = 1;
        setTimeout(() => { toast.style.opacity = 0; }, 2000);
    }
    
    // Hàm giỏ hàng (giữ nguyên)
    function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const cartCount = document.getElementById('cart-count');
        if (cartCount) cartCount.textContent = cart.length;
    }
    window.addToCart = function(productId) {
        const productToAdd = allProducts.find(p => p.id === productId);
        if (!productToAdd) return;
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const productIndex = cart.findIndex(item => item.id === productId);

        if (productIndex > -1) {
            cart[productIndex].quantity = (cart[productIndex].quantity || 1) + 1;
        } else {
            const newItem = { id: productToAdd.id, name: productToAdd.name, price: productToAdd.price, image: productToAdd.image, quantity: 1 };
            cart.push(newItem);
        }

        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCount();
        showToast(`Đã thêm 1 x "${productToAdd.name}" vào giỏ hàng!`);
    }

    function renderProducts(products) {
        const grid = document.getElementById('products-grid');
        const countDisplay = document.getElementById('product-count-display');
        
        if (!grid) return;

        // Xử lý phân trang
        const totalProducts = products.length;
        const startIndex = (currentPage - 1) * productsPerPage;
        const endIndex = startIndex + productsPerPage;
        const productsOnPage = products.slice(startIndex, endIndex);

        grid.innerHTML = '';
        
        if (productsOnPage.length === 0) {
            grid.innerHTML = '<p class="col-span-3 text-center text-gray-500">Không tìm thấy sản phẩm nào.</p>';
            countDisplay.textContent = 'Hiển thị 0 sản phẩm';
            renderPagination(totalProducts); 
            return;
        }
        
        const displayStart = startIndex + 1;
        const displayEnd = startIndex + productsOnPage.length;
        
        countDisplay.textContent = `Hiển thị ${displayStart}-${displayEnd} của ${totalProducts} sản phẩm`;


        productsOnPage.forEach((product) => {
            const stars = Array(5).fill(0).map((_, i) => 
                `<i class="fas fa-star ${product.rating > i ? 'text-yellow-400' : 'text-gray-300'}"></i>`
            ).join('');
            
            grid.innerHTML += `
                <div class="bg-white card overflow-hidden">
                    <div class="relative">
                        <img src="${product.image}" alt="${product.name}" class="w-full h-48 object-cover">
                        <span class="absolute top-2 left-2 bg-green-500 text-white px-2 py-1 rounded text-sm">${product.isOrganic ? 'Hữu cơ' : 'Giảm 10%'}</span>
                        <button class="absolute top-2 right-2 w-8 h-8 bg-white rounded-full flex items-center justify-center hover:bg-gray-100">
                            <i class="far fa-heart text-gray-600"></i>
                        </button>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-lg mb-2">${product.name}</h3>
                        <p class="text-gray-600 text-sm mb-3">${product.description || ''}</p>
                        <div class="flex items-center mb-2">
                            <div class="flex text-sm">${stars}</div>
                            <span class="text-gray-500 text-sm ml-2">(${product.reviews})</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="text-green-600 font-bold text-lg">${product.price.toLocaleString('vi-VN')}đ</span>
                            </div>
                            <button class="btn-primary text-white px-3 py-1 rounded transition" onclick="addToCart(${product.id})">
                                <i class="fas fa-plus"></i> Mua hàng
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        renderPagination(totalProducts);
    }

    function renderPagination(totalProducts) {
        const paginationContainer = document.getElementById('pagination-container');
        const totalPages = Math.ceil(totalProducts / productsPerPage);
        
        paginationContainer.innerHTML = '';

        if (totalPages <= 1) return;

        let paginationHTML = '';
        
        // Nút Previous
        paginationHTML += `
            <button class="px-4 py-2 mx-1 border rounded-lg transition ${currentPage === 1 ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white hover:bg-green-100 text-green-600'}" 
                onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left text-xs"></i>
            </button>
        `;

        // Các nút số trang
        for (let i = 1; i <= totalPages; i++) {
            paginationHTML += `
                <button class="px-4 py-2 mx-1 border rounded-lg font-semibold transition ${i === currentPage ? 'bg-green-500 text-white hover:bg-green-600' : 'bg-white hover:bg-gray-100 text-gray-700'}" 
                    onclick="changePage(${i})">
                    ${i}
                </button>
            `;
        }

        // Nút Next
        paginationHTML += `
            <button class="px-4 py-2 mx-1 border rounded-lg transition ${currentPage === totalPages ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white hover:bg-green-100 text-green-600'}" 
                onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                <i class="fas fa-chevron-right text-xs"></i>
            </button>
        `;

        paginationContainer.innerHTML = paginationHTML;
    }

    /**
     * Thay đổi trang hiện tại và render lại sản phẩm
     * @param {number} page - Số trang muốn chuyển đến
     */
    window.changePage = function(page) {
        const totalPages = Math.ceil(currentFilteredProducts.length / productsPerPage);
        if (page < 1 || page > totalPages) return;
        
        currentPage = page;
        renderProducts(currentFilteredProducts);
        updateUrl(); // <<-- CẬP NHẬT URL
        
        document.getElementById('products-grid').scrollIntoView({ behavior: 'smooth' });
    }

    /**
     * Áp dụng tất cả các bộ lọc, sắp xếp và phân trang.
     * @param {boolean} resetPage - Có nên reset về trang 1 khi thay đổi lọc/sắp xếp không (Mặc định: true)
     */
    function applyFilters(resetPage = true) {
        let filteredProducts = [...allProducts];

        // 1. Lọc theo Danh mục
        const selectedCategories = Array.from(document.querySelectorAll('.category-filter:checked'))
                                     .map(input => input.getAttribute('data-category'));
        
        if (selectedCategories.length > 0) {
            filteredProducts = filteredProducts.filter(p => selectedCategories.includes(p.category));
        }

        // 2. Lọc theo Giá
        const selectedPrice = document.querySelector('.price-filter:checked');
        if (selectedPrice) {
            const [minStr, maxStr] = selectedPrice.value.split('-');
            const min = parseInt(minStr);
            const max = maxStr === 'max' ? Infinity : parseInt(maxStr);
            
            filteredProducts = filteredProducts.filter(p => p.price >= min && p.price <= max);
        }

        // 3. Lọc theo Tìm kiếm
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        if (searchTerm) {
            filteredProducts = filteredProducts.filter(p => 
                p.name.toLowerCase().includes(searchTerm) || 
                p.description.toLowerCase().includes(searchTerm) ||
                (p.category || '').toLowerCase().includes(searchTerm)
            );
        }

        // 4. Sắp xếp
        const sortValue = document.getElementById('sort-select').value;
        if (sortValue === 'price-asc') {
            filteredProducts.sort((a, b) => a.price - b.price);
        } else if (sortValue === 'price-desc') {
            filteredProducts.sort((a, b) => b.price - a.price);
        } else if (sortValue === 'newest') {
            filteredProducts.sort((a, b) => b.id - a.id);
        } else if (sortValue === 'best-seller') {
            filteredProducts.sort((a, b) => b.reviews - a.reviews);
        }

        // Cập nhật danh sách sản phẩm đã lọc
        currentFilteredProducts = filteredProducts;
        
        // Đặt lại trang về 1 nếu bộ lọc thay đổi (trừ khi được gọi từ loadStateFromUrl)
        if (resetPage) {
             currentPage = 1;
        }

        renderProducts(currentFilteredProducts);
        updateUrl(); // <<-- CẬP NHẬT URL
    }

    // --- GẮN SỰ KIỆN KHI TRANG LOAD ---

    document.addEventListener('DOMContentLoaded', function() {
        // 1. Logic trạng thái đăng nhập (giữ nguyên)
        const userInfo = document.getElementById('user-info');
        let user = localStorage.getItem('user');
        if (user) {
            user = JSON.parse(user);
            userInfo.innerHTML = `
                <span class="font-semibold text-green-600">${user.email}</span>
                <button id="logoutBtn" class="bg-gray-200 text-gray-700 px-3 py-2 rounded-full hover:bg-gray-300 transition">Đăng xuất</button>
            `;
            document.getElementById('logoutBtn').onclick = function() {
                localStorage.removeItem('user');
                location.reload();
            };
        } else {
            userInfo.innerHTML = `
                <a href="login.html" class="bg-green-500 text-white px-4 py-2 rounded-full hover:bg-green-600 transition flex items-center justify-center">Đăng nhập</a>
                <a href="register.html" class="bg-orange-500 text-white px-4 py-2 rounded-full hover:bg-orange-600 transition flex items-center justify-center">Đăng ký</a>
            `;
        }

        // 2. Cập nhật số lượng giỏ hàng
        updateCartCount();

        // 3. Khởi tạo trạng thái ban đầu từ URL
        loadStateFromUrl();


        // 4. Gắn sự kiện cho các bộ lọc (chỉ gọi applyFilters)
        document.querySelectorAll('.category-filter, .price-filter').forEach(input => {
            input.addEventListener('change', () => applyFilters(true));
        });

        // Gắn sự kiện cho Sắp xếp
        document.getElementById('sort-select').addEventListener('change', () => applyFilters(true));
        
        // Gắn sự kiện cho Tìm kiếm
        document.getElementById('search-input').addEventListener('input', () => applyFilters(true));
        
        // Xử lý nút back/forward của trình duyệt (Popstate)
        window.addEventListener('popstate', function() {
            loadStateFromUrl();
        });
    });
</script>