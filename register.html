<script>
    // --- KHAI BÁO CẤU HÌNH API THẬT ---
    const API_BASE_URL = 'https://exe-zjbe.onrender.com/api'; 
    // Giả định endpoint đăng ký là /api/auth/register
    const API_REGISTER_URL = `${API_BASE_URL}/auth/register`; 


    // --- UTILITIES VÀ VALIDATION ---

    // Toggle password visibility
    function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const toggle = document.getElementById(fieldId + 'Toggle');
        
        if (field.type === 'password') {
            field.type = 'text';
            toggle.classList.remove('fa-eye');
            toggle.classList.add('fa-eye-slash');
        } else {
            field.type = 'password';
            toggle.classList.remove('fa-eye-slash');
            toggle.classList.add('fa-eye');
        }
    }

    // Password strength checker
    function checkPasswordStrength(password) {
        let strength = 0;
        let feedback = [];

        if (password.length >= 8) strength += 1;
        else feedback.push('ít nhất 8 ký tự');

        if (/[a-z]/.test(password)) strength += 1;
        else feedback.push('chữ thường');

        if (/[A-Z]/.test(password)) strength += 1;
        else feedback.push('chữ hoa');

        if (/[0-9]/.test(password)) strength += 1;
        else feedback.push('số');

        if (/[^A-Za-z0-9]/.test(password)) strength += 1;
        else feedback.push('ký tự đặc biệt');

        return { strength, feedback };
    }

    // Update password strength indicator
    document.getElementById('password').addEventListener('input', function() {
        const password = this.value;
        const strengthBar = document.getElementById('passwordStrength');
        const strengthText = document.getElementById('passwordStrengthText');
        
        if (password.length === 0) {
            strengthBar.style.width = '0%';
            strengthBar.className = 'password-strength bg-gray-200';
            strengthText.textContent = 'Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường và số';
            strengthText.className = 'text-xs mt-1 text-gray-500';
            return;
        }

        const { strength, feedback } = checkPasswordStrength(password);
        const percentage = (strength / 5) * 100;
        
        strengthBar.style.width = percentage + '%';
        
        // Cập nhật màu và thông báo dựa trên độ mạnh
        if (strength <= 2) {
            strengthBar.className = 'password-strength bg-red-500';
            strengthText.textContent = 'Yếu - Cần: ' + feedback.join(', ');
            strengthText.className = 'text-xs mt-1 text-red-500';
        } else if (strength <= 3) {
            strengthBar.className = 'password-strength bg-yellow-500';
            strengthText.textContent = 'Trung bình - Cần: ' + feedback.join(', ');
            strengthText.className = 'text-xs mt-1 text-yellow-600';
        } else if (strength <= 4) {
            strengthBar.className = 'password-strength bg-blue-500';
            strengthText.textContent = 'Khá - Cần: ' + feedback.join(', ');
            strengthText.className = 'text-xs mt-1 text-blue-600';
        } else {
            strengthBar.className = 'password-strength bg-green-500';
            strengthText.textContent = 'Mạnh - Mật khẩu an toàn';
            strengthText.className = 'text-xs mt-1 text-green-600';
        }
    });


    // --- HÀM GỌI API THẬT: Đăng ký người dùng ---
    async function registerUser(userInfo) {
        try {
            // SỬ DỤNG FETCH VỚI API THẬT
            const response = await fetch(API_REGISTER_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userInfo)
            });

            const data = await response.json();

            // Nếu Backend trả về thành công (ví dụ: HTTP 201 Created)
            if (response.ok) {
                return { success: true, user: data };
            } else {
                // Xử lý các lỗi như email đã tồn tại, validation lỗi từ Backend
                return { success: false, error: data.message || 'Lỗi đăng ký từ máy chủ.' };
            }

        } catch (error) {
            console.error("Lỗi kết nối API:", error);
            return { success: false, error: 'Không thể kết nối đến máy chủ. Vui lòng kiểm tra lại đường truyền hoặc CORS.' };
        }
    }


    // Form validation and submission
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Get form values
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const email = document.getElementById('email').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const dateOfBirth = document.getElementById('dateOfBirth').value;
        const gender = document.querySelector('input[name="gender"]:checked')?.value || 'Không xác định';
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const terms = document.getElementById('terms').checked;
        const newsletter = document.getElementById('newsletter').checked;
        
        // Elements
        const btn = document.getElementById('registerBtn');
        const btnText = document.getElementById('registerBtnText');
        const spinner = document.getElementById('registerSpinner');
        
        // Reset errors
        const errorFields = ['firstNameError', 'lastNameError', 'emailError', 'phoneError', 'passwordError', 'confirmPasswordError', 'termsError'];
        errorFields.forEach(field => {
            const el = document.getElementById(field);
            // Giả định bạn có thuộc tính data-default-error trong HTML cho lỗi mặc định
            el.textContent = el.getAttribute('data-default-error') || ''; 
            el.classList.add('hidden');
        });
        
        let isValid = true;
        
        // --- VALIDATION TỪNG TRƯỜNG ---
        if (!firstName) { document.getElementById('firstNameError').classList.remove('hidden'); isValid = false; }
        if (!lastName) { document.getElementById('lastNameError').classList.remove('hidden'); isValid = false; }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) { document.getElementById('emailError').classList.remove('hidden'); isValid = false; }
        
        const phoneRegex = /^[0-9]{10,11}$/;
        // Bỏ khoảng trắng trước khi kiểm tra SĐT
        if (!phoneRegex.test(phone.replace(/\s/g, ''))) { document.getElementById('phoneError').classList.remove('hidden'); isValid = false; }
        
        const { strength } = checkPasswordStrength(password);
        if (strength < 3) { document.getElementById('passwordError').classList.remove('hidden'); isValid = false; }
        
        if (password !== confirmPassword) { document.getElementById('confirmPasswordError').classList.remove('hidden'); isValid = false; }
        
        if (!terms) { document.getElementById('termsError').classList.remove('hidden'); isValid = false; }
        // --- END VALIDATION ---
        
        if (isValid) {
            // Show loading state
            btn.disabled = true;
            btn.classList.add('opacity-70');
            btnText.textContent = 'Đang tạo tài khoản...';
            spinner.classList.remove('hidden');

            const newUserInfo = {
                firstName,
                lastName,
                email,
                phone,
                dateOfBirth,
                gender,
                password,
                newsletter
            };
            
            // GỌI API THẬT
            const result = await registerUser(newUserInfo);
            
            // Reset button state
            btn.disabled = false;
            btn.classList.remove('opacity-70');
            btnText.textContent = 'Tạo tài khoản';
            spinner.classList.add('hidden');
            
            if (result.success) {
                alert('Đăng ký thành công! Vui lòng đăng nhập.');
                // Chuyển hướng đến trang đăng nhập sau khi đăng ký thành công
                window.location.href = 'login.html'; 
            } else {
                // Hiển thị lỗi từ API (ví dụ: email đã tồn tại)
                const emailErrorDiv = document.getElementById('emailError');
                emailErrorDiv.textContent = result.error;
                emailErrorDiv.classList.remove('hidden');
            }
        }
    });

    // Real-time validation (Giữ nguyên)
    document.getElementById('email').addEventListener('blur', function() {
        const email = this.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const errorDiv = document.getElementById('emailError');
        
        // Nếu trường trống thì không báo lỗi blur
        if (email && !emailRegex.test(email)) {
            errorDiv.textContent = 'Vui lòng nhập email hợp lệ';
            errorDiv.classList.remove('hidden');
        } else {
            errorDiv.classList.add('hidden');
        }
    });

    document.getElementById('confirmPassword').addEventListener('input', function() {
        const password = document.getElementById('password').value;
        const confirmPassword = this.value;
        const errorDiv = document.getElementById('confirmPasswordError');
        
        if (confirmPassword && password !== confirmPassword) {
            errorDiv.classList.remove('hidden');
        } else {
            errorDiv.classList.add('hidden');
        }
    });
</script>